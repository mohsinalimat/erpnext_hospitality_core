
================================================================================
Folder: .
================================================================================

------------------------------------------------------------
File: patches.txt
------------------------------------------------------------
[pre_model_sync]
# Patches added in this section will be executed before doctypes are migrated
# Read docs to understand patches: https://frappeframework.com/docs/v14/user/en/database-migrations

[post_model_sync]
# Patches added in this section will be executed after doctypes are migrated

------------------------------------------------------------
File: modules.txt
------------------------------------------------------------
Hospitality Core

------------------------------------------------------------
File: hooks.py
------------------------------------------------------------
app_name = "hospitality_core"
app_title = "Hospitality Core"
app_publisher = "Gift Braimah"
app_description = "Hotel Management Module"
app_email = "braimahgifted@gmail.com"
app_license = "gpl-2.0"

# Document Events
doc_events = {
    "Guest Folio": {
        "on_update": "hospitality_core.hospitality_core.api.folio.sync_folio_balance"
    },
    "Folio Transaction": {
        "after_save": "hospitality_core.hospitality_core.api.folio.sync_folio_balance",
        "on_trash": "hospitality_core.hospitality_core.api.folio.sync_folio_balance"
    },
    "POS Invoice": {
        "on_submit": "hospitality_core.hospitality_core.api.pos_bridge.process_room_charge"
    },
    "Payment Entry": {
        "on_submit": "hospitality_core.hospitality_core.api.payment_bridge.process_payment_entry"
    }
}

after_install = "hospitality_core.setup.after_install"

# Scheduled Tasks
# changed daily audit to run at 2 PM (14:00) per requirements
scheduler_events = {
    "cron": {
        "0 14 * * *": [
            "hospitality_core.hospitality_core.api.night_audit.run_daily_audit"
        ]
    }
}

# Fixtures
fixtures = [
    {"dt": "Custom Field", "filters": [["module", "=", "Hospitality Core"]]},
    {"dt": "Property Setter", "filters": [["module", "=", "Hospitality Core"]]}
]

------------------------------------------------------------
File: setup.py
------------------------------------------------------------
import frappe
from frappe import _

def after_install():
    create_roles()
    create_custom_fields()
    create_default_data()

def create_roles():
    roles = ["Hospitality User", "Hospitality Manager", "Housekeeping Staff"]
    for role in roles:
        if not frappe.db.exists("Role", role):
            frappe.get_doc({"doctype": "Role", "role_name": role, "desk_access": 1}).insert()

def create_custom_fields():
    # Add 'Room Charge' to Mode of Payment if not exists
    if not frappe.db.exists("Mode of Payment", "Room Charge"):
        mode = frappe.new_doc("Mode of Payment")
        mode.mode_of_payment = "Room Charge"
        mode.type = "General"
        mode.insert()

    # Add 'hotel_room' field to POS Invoice if not exists
    if not frappe.db.exists("Custom Field", {"dt": "POS Invoice", "fieldname": "hotel_room"}):
        frappe.get_doc({
            "doctype": "Custom Field",
            "dt": "POS Invoice",
            "fieldname": "hotel_room",
            "label": "Hotel Room Number",
            "fieldtype": "Link",
            "options": "Hotel Room",
            "insert_after": "customer"
        }).insert()

def create_default_data():
    # Create default Allowance Reason Codes
    reasons = [
        {"code": "POST-ERR", "desc": "Posting Error", "mgr": 0},
        {"code": "GUEST-SAT", "desc": "Guest Satisfaction / Complaint", "mgr": 1},
        {"code": "MGMT-COMP", "desc": "Management Complementary", "mgr": 1}
    ]
    
    for r in reasons:
        if not frappe.db.exists("Allowance Reason Code", r["code"]):
            frappe.get_doc({
                "doctype": "Allowance Reason Code",
                "reason_code": r["code"],
                "description": r["desc"],
                "requires_manager_approval": r["mgr"]
            }).insert()

    # Create Service Items
    items = [
        {"code": "ROOM-RENT", "name": "Room Rent"},
        {"code": "POS-CHARGE", "name": "POS Charge"},
        {"code": "PAYMENT", "name": "Payment Credit"}
    ]
    for i in items:
        if not frappe.db.exists("Item", i["code"]):
            item = frappe.new_doc("Item")
            item.item_code = i["code"]
            item.item_name = i["name"]
            item.item_group = "Services" if frappe.db.exists("Item Group", "Services") else "All Item Groups"
            item.is_stock_item = 0
            item.insert(ignore_permissions=True)

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------
__version__ = "0.0.1"


================================================================================
Folder: __pycache__
================================================================================

------------------------------------------------------------
File: hooks.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


------------------------------------------------------------
File: setup.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: templates
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: templates/includes
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: templates/pages
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: config
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/page
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/page/front_desk_console
================================================================================

------------------------------------------------------------
File: front_desk_console.json
------------------------------------------------------------
{
 "content": null,
 "creation": "2025-01-28 10:00:00.000000",
 "docstatus": 0,
 "doctype": "Page",
 "idx": 0,
 "modified": "2025-01-28 10:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "front-desk-console",
 "owner": "Administrator",
 "page_name": "front-desk-console",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ],
 "standard": "Yes",
 "title": "Front Desk Console"
}

------------------------------------------------------------
File: front_desk_console.js
------------------------------------------------------------
frappe.pages['front-desk-console'].on_page_load = function (wrapper) {
    var page = frappe.ui.make_app_page({
        parent: wrapper,
        title: 'Front Desk Console',
        single_column: true
    });

    // 1. Add Date Filter
    page.add_field({
        fieldname: 'console_date',
        label: 'Date',
        fieldtype: 'Date',
        default: frappe.datetime.now_date(),
        change: function () {
            render_console(wrapper, page);
        }
    });

    // Refresh Button
    page.set_primary_action('Refresh Data', function () {
        render_console(wrapper, page);
    });

    // CSS Styling
    $(`<style>
        .fd-stat-card {
            background: #fff;
            border: 1px solid #d1d8dd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
            height: 100%;
        }
        .fd-stat-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .fd-stat-number { font-size: 32px; font-weight: 700; color: #1f272e; margin: 10px 0; }
        .fd-stat-label { font-size: 13px; color: #8d99a6; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .fd-toolbar-btn {
            display: inline-block;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #ebf1f5;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            color: #36414c;
            font-weight: 600;
        }
        .fd-toolbar-btn:hover { background: #e2e6ea; text-decoration: none; color: #1f272e; }
        .fd-toolbar-icon { font-size: 24px; display: block; margin-bottom: 8px; color: #5e64ff; }

        .fd-list-header { background: #f0f4f7; padding: 10px 15px; font-weight: bold; border-radius: 4px 4px 0 0; border: 1px solid #d1d8dd; border-bottom: none; }
        .fd-list-container { border: 1px solid #d1d8dd; border-radius: 0 0 4px 4px; background: #fff; min-height: 300px; max-height: 500px; overflow-y: auto; }
        .fd-list-item { padding: 12px 15px; border-bottom: 1px solid #f1f1f1; display: flex; align-items: center; justify-content: space-between; }
        .fd-list-item:hover { background: #fafbfc; }
        .fd-list-item:last-child { border-bottom: none; }
        
        .badge-pending { background: #fff5e6; color: #ff9f43; border: 1px solid #ff9f43; padding: 2px 8px; border-radius: 12px; font-size: 11px; }
        .badge-done { background: #e8f5e9; color: #28a745; border: 1px solid #28a745; padding: 2px 8px; border-radius: 12px; font-size: 11px; }
        .badge-missed { background: #ffebee; color: #c62828; border: 1px solid #c62828; padding: 2px 8px; border-radius: 12px; font-size: 11px; }
    </style>`).appendTo(wrapper);

    // Main Layout Skeleton
    // CORRECTION: Removed 'page' argument from set_route for custom pages
    $(wrapper).find('.layout-main-section').append(`
        <div id="fd-content" style="padding-top: 10px;">
            <!-- Quick Actions Row -->
            <div class="row" style="margin-bottom: 20px;">
                <div class="col-md-2 col-xs-4"><a class="fd-toolbar-btn" onclick="frappe.set_route('tape-chart')">Tape Chart</a></div>
                <div class="col-md-2 col-xs-4"><a class="fd-toolbar-btn" onclick="frappe.set_route('availability-tool')">Availability</a></div>
                <div class="col-md-2 col-xs-4"><a class="fd-toolbar-btn" onclick="frappe.set_route('housekeeping-view')">Housekeeping</a></div>
                <div class="col-md-2 col-xs-4"><a class="fd-toolbar-btn" onclick="frappe.set_route('List', 'Hotel Reservation')">Reservations</a></div>
                <div class="col-md-2 col-xs-4"><a class="fd-toolbar-btn" onclick="frappe.set_route('List', 'Guest')">Guest List</a></div>
                <div class="col-md-2 col-xs-4"><a class="fd-toolbar-btn" onclick="frappe.set_route('List', 'Hotel Maintenance Request')">Maintenance</a></div>
            </div>

            <!-- Stats Row -->
            <div class="row" style="margin-bottom: 30px;">
                <div class="col-md-3">
                    <div class="fd-stat-card">
                        <div class="fd-stat-label">Arrivals Pending</div>
                        <div class="fd-stat-number" id="stat-arr-pending" style="color: #ff9f43">0</div>
                        <small class="text-muted">For selected date</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="fd-stat-card">
                        <div class="fd-stat-label">Departures Pending</div>
                        <div class="fd-stat-number" id="stat-dep-pending" style="color: #ef5350">0</div>
                        <small class="text-muted">For selected date</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="fd-stat-card">
                        <div class="fd-stat-label">Rooms In-House</div>
                        <div class="fd-stat-number" id="stat-occupancy">0</div>
                        <small class="text-muted" id="stat-occ-pct">0% Occupancy</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="fd-stat-card">
                        <div class="fd-stat-label">Available Rooms</div>
                        <div class="fd-stat-number" id="stat-available" style="color: #28a745">0</div>
                        <small class="text-muted">Net Availability</small>
                    </div>
                </div>
            </div>

            <!-- Lists Row -->
            <div class="row">
                <!-- Arrivals Column -->
                <div class="col-md-6">
                    <div class="fd-list-header">
                        <span class="fas fa-plane-arrival" style="color:#5e64ff; margin-right:5px;"></span> Arrivals
                    </div>
                    <div id="list-arrivals" class="fd-list-container">
                        <div class="text-center p-3 text-muted">Loading...</div>
                    </div>
                </div>

                <!-- Departures Column -->
                <div class="col-md-6">
                    <div class="fd-list-header">
                        <span class="fas fa-plane-departure" style="color:#ef5350; margin-right:5px;"></span> Departures
                    </div>
                    <div id="list-departures" class="fd-list-container">
                        <div class="text-center p-3 text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    `);

    render_console(wrapper, page);
}

function render_console(wrapper, page) {
    let selected_date = page.fields_dict.console_date.get_value();

    frappe.call({
        method: "hospitality_core.hospitality_core.page.front_desk_console.front_desk_console.get_console_data",
        args: { target_date: selected_date },
        callback: function (r) {
            if (r.message) {
                update_stats(r.message.stats);
                render_arrivals(r.message.arrivals);
                render_departures(r.message.departures);
            }
        }
    });
}

function update_stats(stats) {
    $('#stat-arr-pending').text(stats.arrivals_pending);
    $('#stat-dep-pending').text(stats.departures_pending);
    $('#stat-occupancy').text(stats.in_house);
    $('#stat-occ-pct').text(stats.occupancy_pct + '% Occupancy');
    $('#stat-available').text(stats.available);
}

function render_arrivals(data) {
    let html = '';
    if (data.length === 0) {
        html = '<div class="text-center p-4 text-muted">No arrivals found for this date.</div>';
    } else {
        data.forEach(d => {
            let is_pending = d.status === 'Reserved';
            let is_arrived = d.status === 'Checked In' || d.status === 'Checked Out';
            let badge = '';

            if (is_arrived) {
                badge = '<span class="badge-done"><i class="fa fa-check"></i> Arrived</span>';
            } else if (is_pending) {
                let is_past = frappe.datetime.get_diff(frappe.datetime.now_date(), d.arrival_date) > 0;
                if (is_past) badge = '<span class="badge-missed">No Show</span>';
                else badge = '<span class="badge-pending">Pending Check-in</span>';
            }

            html += `
            <div class="fd-list-item">
                <div style="flex:1;">
                    <div style="font-weight:600; font-size:14px;">
                        <a href="#" onclick="frappe.set_route('Form', 'Hotel Reservation', '${d.name}')">${d.guest_name}</a>
                    </div>
                    <div style="font-size:12px; color:#6c757d;">
                        <span class="fas fa-bed"></span> ${d.room || 'Unassigned'} &middot; ${d.room_type}
                    </div>
                </div>
                <div class="text-right">
                    <div style="margin-bottom:4px;">${badge}</div>
                    ${d.status === 'Reserved' ? `<button class="btn btn-xs btn-primary" onclick="frappe.set_route('Form', 'Hotel Reservation', '${d.name}')">Open</button>` : ''}
                </div>
            </div>`;
        });
    }
    $('#list-arrivals').html(html);
}

function render_departures(data) {
    let html = '';
    if (data.length === 0) {
        html = '<div class="text-center p-4 text-muted">No departures found for this date.</div>';
    } else {
        data.forEach(d => {
            let is_left = d.status === 'Checked Out';
            let is_pending = d.status === 'Checked In';
            let badge = '';

            if (is_left) {
                badge = '<span class="badge-done"><i class="fa fa-check"></i> Checked Out</span>';
            } else if (is_pending) {
                let is_past = frappe.datetime.get_diff(frappe.datetime.now_date(), d.departure_date) > 0;
                if (is_past) badge = '<span class="badge-missed">Overstay</span>';
                else badge = '<span class="badge-pending">Expected Departure</span>';
            }

            html += `
            <div class="fd-list-item">
                <div style="flex:1;">
                    <div style="font-weight:600; font-size:14px;">
                        <a href="#" onclick="frappe.set_route('Form', 'Hotel Reservation', '${d.name}')">${d.guest_name}</a>
                    </div>
                    <div style="font-size:12px; color:#6c757d;">
                        <span class="fas fa-door-open"></span> ${d.room} &middot; ${d.room_type}
                    </div>
                </div>
                <div class="text-right">
                    <div style="margin-bottom:4px;">${badge}</div>
                    ${d.status === 'Checked In' ? `<button class="btn btn-xs btn-danger" onclick="frappe.set_route('Form', 'Hotel Reservation', '${d.name}')">Checkout</button>` : ''}
                </div>
            </div>`;
        });
    }
    $('#list-departures').html(html);
}

------------------------------------------------------------
File: front_desk_console.py
------------------------------------------------------------
import frappe
from frappe.utils import nowdate, flt, getdate

@frappe.whitelist()
def get_console_data(target_date=None):
    if not target_date:
        target_date = nowdate()
    
    # 1. Fetch Arrivals for specific date
    # Include 'Checked Out' in arrivals list if they arrived AND left on the target date (Day Use)
    arrivals = frappe.db.sql("""
        SELECT res.name, g.full_name as guest_name, res.status, res.room, res.room_type, res.arrival_date
        FROM `tabHotel Reservation` res
        LEFT JOIN `tabGuest` g ON res.guest = g.name
        WHERE res.arrival_date = %s 
        AND res.status IN ('Reserved', 'Checked In', 'Checked Out')
        ORDER BY res.status DESC, g.full_name ASC
    """, (target_date,), as_dict=True)

    # 2. Fetch Departures for specific date
    departures = frappe.db.sql("""
        SELECT res.name, g.full_name as guest_name, res.status, res.room, res.room_type, res.departure_date
        FROM `tabHotel Reservation` res
        LEFT JOIN `tabGuest` g ON res.guest = g.name
        WHERE res.departure_date = %s 
        AND res.status IN ('Checked In', 'Checked Out')
        ORDER BY res.status ASC, res.room ASC
    """, (target_date,), as_dict=True)

    # 3. Stats Calculation (Date Sensitive)
    total_rooms = frappe.db.count("Hotel Room", {"is_enabled": 1})
    
    # Calculate In-House (Night Occupancy)
    # Logic: Arrived <= Today AND Departing > Today.
    # This captures:
    #   - Old Check-ins (Stayovers)
    #   - New Check-ins (Arrivals)
    # It Excludes:
    #   - Due Outs (Departing Today) -> These rooms are considered available for tonight once vacated.
    in_house_count = frappe.db.count("Hotel Reservation", {
        "arrival_date": ["<=", target_date],
        "departure_date": [">", target_date],
        "status": "Checked In" 
    })

    # Arrivals Pending (Reserved for this date)
    # These represent potential In-House guests for tonight who haven't arrived yet.
    arrivals_pending = len([a for a in arrivals if a.status == 'Reserved'])
    
    # Departures Pending (Checked In with departure on this date)
    # These are guests physically present right now but expected to leave.
    departures_pending = len([d for d in departures if d.status == 'Checked In'])
    
    available_today_departures = len([d for d in departures if d.status == 'Checked Out'])
    
    # Available Rooms Calculation
    # Logic: Total - (Currently In House for Night + Reserved Arrivals) - OOO
    # Note: A room that checks out today is available for a new arrival tonight.
    ooo_rooms = frappe.db.count("Hotel Room", {"status": "Out of Order", "is_enabled": 1})
    
    # Committed Rooms = People staying tonight + People arriving tonight
    committed_rooms = in_house_count + arrivals_pending
    
    available = total_rooms - committed_rooms - ooo_rooms
    if available < 0: available = 0

    occupancy_pct = 0
    if total_rooms > 0:
        occupancy_pct = flt((in_house_count / total_rooms) * 100, 1)

    return {
        "arrivals": arrivals,
        "departures": departures,
        "stats": {
            "total_rooms": total_rooms,
            "in_house": in_house_count,
            "occupancy_pct": occupancy_pct,
            "arrivals_pending": arrivals_pending,
            "departures_pending": departures_pending,
            "available": available
        }
    }

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/page/front_desk_console/__pycache__
================================================================================

------------------------------------------------------------
File: front_desk_console.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/page/tape_chart
================================================================================

------------------------------------------------------------
File: tape_chart.json
------------------------------------------------------------
{
 "content": null,
 "creation": "2025-01-28 10:00:00.000000",
 "docstatus": 0,
 "doctype": "Page",
 "idx": 0,
 "modified": "2025-01-28 10:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "tape-chart",
 "owner": "Administrator",
 "page_name": "tape-chart",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ],
 "standard": "Yes",
 "title": "Tape Chart"
}

------------------------------------------------------------
File: tape_chart.js
------------------------------------------------------------
frappe.pages['tape-chart'].on_page_load = function(wrapper) {
    var page = frappe.ui.make_app_page({
        parent: wrapper,
        title: 'Tape Chart (Reservation Calendar)',
        single_column: true
    });

    // Filters
    page.add_field({
        fieldname: 'start_date',
        label: 'Start Date',
        fieldtype: 'Date',
        default: frappe.datetime.now_date(),
        change: function() {
            render_tape_chart(wrapper, page);
        }
    });

    $(wrapper).find('.layout-main-section').append('<div id="tape-chart-container" style="overflow-x: auto; margin-top: 20px;"></div>');
    
    render_tape_chart(wrapper, page);
}

function render_tape_chart(wrapper, page) {
    let start_date = page.fields_dict.start_date.get_value();
    let end_date = frappe.datetime.add_days(start_date, 14); // 2 week view

    frappe.call({
        method: "hospitality_core.hospitality_core.page.tape_chart.tape_chart.get_chart_data",
        args: {
            start_date: start_date,
            end_date: end_date
        },
        callback: function(r) {
            if(r.message) {
                draw_grid(r.message, start_date, end_date);
            }
        }
    });
}

function draw_grid(data, start, end) {
    let rooms = data.rooms;
    let bookings = data.bookings;
    let container = $('#tape-chart-container');
    container.empty();

    // Simple Table Construction
    let html = `<table class="table table-bordered table-sm" style="font-size: 11px;">
        <thead><tr><th style="width: 80px;">Room</th>`;
    
    // Header Dates
    let dates = [];
    let curr = start;
    while(curr <= end) {
        dates.push(curr);
        html += `<th style="min-width: 40px; text-align: center;">${curr.split('-')[2]}</th>`;
        curr = frappe.datetime.add_days(curr, 1);
    }
    html += `</tr></thead><tbody>`;

    // Room Rows
    rooms.forEach(room => {
        html += `<tr><td><b>${room.room_number}</b><br><small>${room.room_type}</small></td>`;
        
        dates.forEach(date => {
            // Find booking for this room on this date
            let booking = bookings.find(b => 
                b.room === room.name && 
                date >= b.arrival_date && 
                date < b.departure_date // Standard Hotel Logic: Departure day is free
            );

            if (booking) {
                let color = booking.status === 'Checked In' ? '#d4edda' : '#fff3cd'; // Green vs Yellow
                html += `<td style="background-color: ${color}; text-align: center; vertical-align: middle; cursor: pointer;" 
                            title="${booking.guest} (${booking.status})"
                            onclick="frappe.set_route('Form', 'Hotel Reservation', '${booking.name}')">
                            ${booking.name.split('-').pop()}
                         </td>`;
            } else {
                html += `<td></td>`;
            }
        });
        html += `</tr>`;
    });

    html += `</tbody></table>`;
    container.html(html);
}

------------------------------------------------------------
File: tape_chart.py
------------------------------------------------------------
import frappe
from frappe.utils import getdate

@frappe.whitelist()
def get_chart_data(start_date, end_date):
    # 1. Get all Enabled Rooms
    rooms = frappe.get_all("Hotel Room", 
        filters={"is_enabled": 1}, 
        fields=["name", "room_number", "room_type"],
        order_by="room_number asc"
    )

    # 2. Get Reservations in range
    # Logic: Arrival < End AND Departure > Start
    bookings = frappe.db.sql("""
        SELECT name, guest, room, arrival_date, departure_date, status
        FROM `tabHotel Reservation`
        WHERE status IN ('Reserved', 'Checked In')
        AND arrival_date < %(end)s AND departure_date > %(start)s
    """, {"start": start_date, "end": end_date}, as_dict=True)

    return {
        "rooms": rooms,
        "bookings": bookings
    }

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/page/tape_chart/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: tape_chart.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/page/availability_tool
================================================================================

------------------------------------------------------------
File: availability_tool.py
------------------------------------------------------------
import frappe

@frappe.whitelist()
def check_availability_counts(start_date, end_date):
    # 1. Get all Room Types and their Counts
    room_types = frappe.db.sql("""
        SELECT room_type, COUNT(name) as total 
        FROM `tabHotel Room` 
        WHERE is_enabled = 1 
        GROUP BY room_type
    """, as_dict=True)

    results = []

    for rt in room_types:
        # 2. Count Bookings for this Type in Date Range
        # Logic: Overlapping reservations
        occupied = frappe.db.count("Hotel Reservation", {
            "room_type": rt.room_type,
            "status": ["in", ["Reserved", "Checked In"]],
            "arrival_date": ["<", end_date],
            "departure_date": [">", start_date]
        })
        
        results.append({
            "room_type": rt.room_type,
            "total": rt.total,
            "occupied": occupied,
            "available": rt.total - occupied
        })

    return results

------------------------------------------------------------
File: availability_tool.json
------------------------------------------------------------
{
 "content": null,
 "creation": "2025-01-28 10:00:00.000000",
 "docstatus": 0,
 "doctype": "Page",
 "idx": 0,
 "modified": "2025-01-28 10:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "availability-tool",
 "owner": "Administrator",
 "page_name": "availability-tool",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ],
 "standard": "Yes",
 "title": "Availability Tool"
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


------------------------------------------------------------
File: availability_tool.js
------------------------------------------------------------
frappe.pages['availability-tool'].on_page_load = function(wrapper) {
    var page = frappe.ui.make_app_page({
        parent: wrapper,
        title: 'Room Availability Query',
        single_column: true
    });

    page.add_field({
        fieldname: 'date_range',
        label: 'Date Range',
        fieldtype: 'DateRange',
        default: [frappe.datetime.now_date(), frappe.datetime.add_days(frappe.datetime.now_date(), 1)],
        reqd: 1
    });

    page.set_primary_action('Check', function() {
        let dates = page.fields_dict.date_range.get_value();
        if(!dates) return;
        
        // DateRange field returns string "YYYY-MM-DD to YYYY-MM-DD" or array depending on version.
        // We assume Array for modern Frappe.
        let start = dates[0];
        let end = dates[1];

        frappe.call({
            method: "hospitality_core.hospitality_core.page.availability_tool.availability_tool.check_availability_counts",
            args: { start_date: start, end_date: end },
            freeze: true,
            callback: function(r) {
                render_results(wrapper, r.message);
            }
        });
    });
    
    $(wrapper).find('.layout-main-section').append('<div id="avail-results" style="margin-top:20px;"></div>');
}

function render_results(wrapper, data) {
    let html = `<table class="table table-bordered">
        <thead><tr style="background-color:#f0f4f7;"><th>Room Type</th><th>Total Rooms</th><th>Occupied/Reserved</th><th>Available</th></tr></thead>
        <tbody>`;
    
    data.forEach(row => {
        let color = row.available > 0 ? 'green' : 'red';
        html += `
            <tr>
                <td><b>${row.room_type}</b></td>
                <td>${row.total}</td>
                <td>${row.occupied}</td>
                <td style="color:${color}; font-weight:bold; font-size:1.2em;">${row.available}</td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    $('#avail-results').html(html);
}

================================================================================
Folder: hospitality_core/page/availability_tool/__pycache__
================================================================================

------------------------------------------------------------
File: availability_tool.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/page/housekeeping_view
================================================================================

------------------------------------------------------------
File: housekeeping_view.js
------------------------------------------------------------
frappe.pages['housekeeping-view'].on_page_load = function(wrapper) {
    var page = frappe.ui.make_app_page({
        parent: wrapper,
        title: 'Housekeeping Board',
        single_column: true
    });

    // Refresh Button
    page.set_primary_action('Refresh', function() {
        render_housekeeping_board(wrapper);
    });

    $(wrapper).find('.layout-main-section').append('<div id="hk-board-container" class="row"></div>');
    
    render_housekeeping_board(wrapper);
}

function render_housekeeping_board(wrapper) {
    frappe.call({
        method: "hospitality_core.hospitality_core.page.housekeeping_view.housekeeping_view.get_room_statuses",
        callback: function(r) {
            if(r.message) {
                let container = $('#hk-board-container');
                container.empty();
                
                r.message.forEach(room => {
                    let card_color = '';
                    if (room.status === 'Dirty') card_color = 'border-danger';
                    else if (room.status === 'Occupied') card_color = 'border-primary';
                    else if (room.status === 'Available') card_color = 'border-success'; // Clean
                    else if (room.status === 'Out of Order') card_color = 'border-secondary';

                    let html = `
                    <div class="col-xs-6 col-sm-4 col-md-3 col-lg-2" style="padding: 10px;">
                        <div class="card ${card_color}" style="border-width: 2px; height: 100%;">
                            <div class="card-body text-center">
                                <h4 class="card-title">${room.room_number}</h4>
                                <p class="card-text text-muted">${room.status}</p>
                                ${get_action_buttons(room)}
                            </div>
                        </div>
                    </div>`;
                    container.append(html);
                });
            }
        }
    });
}

function get_action_buttons(room) {
    // Logic: 
    // Dirty -> Click to make Clean (Available)
    // Clean (Available) -> Click to make Dirty (e.g. inspection fail)
    // Occupied -> Cannot change status here (Must check out)
    
    if (room.status === 'Dirty') {
        return `<button class="btn btn-success btn-xs btn-block" onclick="update_room_status('${room.name}', 'Available')">Mark Clean</button>`;
    } else if (room.status === 'Available') {
        return `<button class="btn btn-warning btn-xs btn-block" onclick="update_room_status('${room.name}', 'Dirty')">Mark Dirty</button>`;
    } else {
        return `<small class="text-muted">Locked</small>`;
    }
}

// Global scope function for onclick
window.update_room_status = function(room_name, new_status) {
    frappe.call({
        method: "hospitality_core.hospitality_core.page.housekeeping_view.housekeeping_view.set_room_status",
        args: {
            room: room_name,
            status: new_status
        },
        callback: function(r) {
            // Reload page to reflect changes
            frappe.pages['housekeeping-view'].get_primary_action().trigger('click');
        }
    });
};

------------------------------------------------------------
File: housekeeping_view.json
------------------------------------------------------------
{
 "content": null,
 "creation": "2025-01-28 10:00:00.000000",
 "docstatus": 0,
 "doctype": "Page",
 "idx": 0,
 "modified": "2025-01-28 10:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "housekeeping-view",
 "owner": "Administrator",
 "page_name": "housekeeping-view",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "Housekeeping Staff"
  },
  {
   "role": "System Manager"
  }
 ],
 "standard": "Yes",
 "title": "Housekeeping View"
}

------------------------------------------------------------
File: housekeeping_view.py
------------------------------------------------------------
import frappe

@frappe.whitelist()
def get_room_statuses():
    return frappe.get_all("Hotel Room", 
        fields=["name", "room_number", "status", "room_type"],
        filters={"is_enabled": 1},
        order_by="room_number asc"
    )

@frappe.whitelist()
def set_room_status(room, status):
    # Security check: Ensure user is Housekeeping or Manager
    if not frappe.has_permission("Hotel Room", "write"):
        frappe.throw("Not authorized to change room status")
        
    frappe.db.set_value("Hotel Room", room, "status", status)
    return True

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/page/housekeeping_view/__pycache__
================================================================================

------------------------------------------------------------
File: housekeeping_view.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/page/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/page/guest_360
================================================================================

------------------------------------------------------------
File: guest_360.json
------------------------------------------------------------
{
 "content": null,
 "creation": "2025-01-29 10:00:00.000000",
 "docstatus": 0,
 "doctype": "Page",
 "idx": 0,
 "modified": "2025-01-29 10:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "guest-360",
 "owner": "Administrator",
 "page_name": "guest-360",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "Hospitality Manager"
  },
  {
   "role": "System Manager"
  }
 ],
 "standard": "Yes",
 "title": "Guest 360 View"
}

------------------------------------------------------------
File: guest_360.py
------------------------------------------------------------
import frappe
from frappe.utils import flt

@frappe.whitelist()
def get_guest_details(guest):
    if not guest:
        return {}

    # 1. Profile
    guest_doc = frappe.get_doc("Guest", guest)
    
    # 2. History (Reservations joined with Folio for balance)
    history = frappe.db.sql("""
        SELECT 
            res.name, res.status, res.arrival_date, res.departure_date, res.room, res.room_type,
            COALESCE(gf.outstanding_balance, 0) as balance
        FROM `tabHotel Reservation` res
        LEFT JOIN `tabGuest Folio` gf ON res.folio = gf.name
        WHERE res.guest = %s
        ORDER BY res.arrival_date DESC
    """, (guest,), as_dict=True)

    # 3. Stats
    total_stays = len([h for h in history if h.status == 'Checked Out'])
    
    # Total Spend from Closed Folios
    spend_data = frappe.db.sql("""
        SELECT SUM(total_charges) as total 
        FROM `tabGuest Folio` 
        WHERE guest = %s AND status = 'Closed'
    """, (guest,), as_dict=True)[0]
    total_spend = flt(spend_data.total)
    
    avg_rate = (total_spend / total_stays) if total_stays else 0
    
    last_stay = next((h for h in history if h.status == 'Checked Out'), None)
    
    return {
        "guest": guest_doc,
        "history": history,
        "stats": {
            "total_stays": total_stays,
            "total_spend": total_spend,
            "avg_rate": avg_rate,
            "last_room": last_stay.room if last_stay else None,
            "last_visit": last_stay.departure_date if last_stay else None
        }
    }

------------------------------------------------------------
File: guest_360.js
------------------------------------------------------------
frappe.pages['guest-360'].on_page_load = function(wrapper) {
    var page = frappe.ui.make_app_page({
        parent: wrapper,
        title: 'Guest 360 View',
        single_column: true
    });

    // 1. Search Field
    page.add_field({
        fieldname: 'guest',
        label: 'Search Guest',
        fieldtype: 'Link',
        options: 'Guest',
        change: function() {
            let guest = page.fields_dict.guest.get_value();
            if(guest) render_guest_profile(wrapper, guest);
        }
    });

    // CSS
    $(`<style>
        .g360-card { background: #fff; border: 1px solid #d1d8dd; border-radius: 8px; padding: 20px; margin-bottom: 20px; height: 100%; }
        .g360-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .g360-stat-val { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .g360-stat-label { font-size: 12px; color: #7f8c8d; text-transform: uppercase; }
        .g360-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px;}
        .tag-vip { background: #ffd700; color: #000; }
        .tag-reg { background: #e0e0e0; color: #333; }
        .tag-corp { background: #3498db; color: #fff; }
    </style>`).appendTo(wrapper);

    $(wrapper).find('.layout-main-section').append('<div id="g360-content" style="margin-top: 20px;"></div>');
    
    $('#g360-content').html('<div class="text-center text-muted p-5">Please select a guest to view details.</div>');
}

function render_guest_profile(wrapper, guest_name) {
    frappe.call({
        method: "hospitality_core.hospitality_core.page.guest_360.guest_360.get_guest_details",
        args: { guest: guest_name },
        freeze: true,
        callback: function(r) {
            if(r.message) {
                let d = r.message;
                let html = `
                <div class="row">
                    <!-- Profile Card -->
                    <div class="col-md-4">
                        <div class="g360-card">
                            <div class="g360-header">Profile</div>
                            <div class="text-center mb-3">
                                <div class="avatar avatar-xl" style="width: 80px; height: 80px; margin: 0 auto; background: #f0f0f0; border-radius: 50%; line-height: 80px; font-size: 32px;">
                                    ${d.guest.full_name.charAt(0)}
                                </div>
                                <h4 class="mt-2">${d.guest.full_name}</h4>
                                <span class="g360-tag ${d.guest.guest_type === 'VIP' ? 'tag-vip' : (d.guest.guest_type === 'Corporate' ? 'tag-corp' : 'tag-reg')}">
                                    ${d.guest.guest_type}
                                </span>
                            </div>
                            <table class="table table-borderless table-sm">
                                <tr><td class="text-muted">Email:</td><td>${d.guest.email_id || '-'}</td></tr>
                                <tr><td class="text-muted">Mobile:</td><td>${d.guest.mobile_no || '-'}</td></tr>
                                <tr><td class="text-muted">Customer:</td><td>${d.guest.customer || '-'}</td></tr>
                                <tr><td class="text-muted">Address:</td><td>${d.guest.address || '-'}</td></tr>
                            </table>
                            <button class="btn btn-default btn-sm btn-block mt-3" onclick="frappe.set_route('Form', 'Guest', '${d.guest.name}')">Edit Profile</button>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="col-md-8">
                        <div class="g360-card">
                            <div class="g360-header">Performance Stats</div>
                            <div class="row text-center">
                                <div class="col-sm-4">
                                    <div class="g360-stat-val">${d.stats.total_stays}</div>
                                    <div class="g360-stat-label">Total Visits</div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="g360-stat-val">${format_currency(d.stats.total_spend)}</div>
                                    <div class="g360-stat-label">Lifetime Spend</div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="g360-stat-val">${format_currency(d.stats.avg_rate)}</div>
                                    <div class="g360-stat-label">Avg Nightly Rate</div>
                                </div>
                            </div>
                            <hr>
                            <div class="row text-center mt-3">
                                <div class="col-sm-4">
                                    <div class="g360-stat-val" style="font-size: 18px;">${d.stats.last_room || '-'}</div>
                                    <div class="g360-stat-label">Last Room</div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="g360-stat-val" style="font-size: 18px;">${d.stats.last_visit ? frappe.datetime.str_to_user(d.stats.last_visit) : '-'}</div>
                                    <div class="g360-stat-label">Last Checked Out</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="g360-card">
                            <div class="g360-header">Stay History</div>
                            <table class="table table-bordered table-hover">
                                <thead style="background-color: #f8f9fa;">
                                    <tr>
                                        <th>Reservation</th>
                                        <th>Status</th>
                                        <th>Arrival</th>
                                        <th>Departure</th>
                                        <th>Room</th>
                                        <th>Folio Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${d.history.map(row => `
                                    <tr style="cursor: pointer;" onclick="frappe.set_route('Form', 'Hotel Reservation', '${row.name}')">
                                        <td>${row.name}</td>
                                        <td>${row.status}</td>
                                        <td>${frappe.datetime.str_to_user(row.arrival_date)}</td>
                                        <td>${frappe.datetime.str_to_user(row.departure_date)}</td>
                                        <td>${row.room} - ${row.room_type}</td>
                                        <td class="text-right">${format_currency(row.balance)}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${d.history.length === 0 ? '<p class="text-center text-muted">No history found.</p>' : ''}
                        </div>
                    </div>
                </div>
                `;
                $('#g360-content').html(html);
            }
        }
    });
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------
# This file makes the directory a Python package

================================================================================
Folder: hospitality_core/page/guest_360/__pycache__
================================================================================

------------------------------------------------------------
File: guest_360.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/doctype
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/lost_and_found_item
================================================================================

------------------------------------------------------------
File: lost_and_found_item.json
------------------------------------------------------------
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "format:LNF-{YYYY}-{####}",
 "creation": "2025-01-28 11:25:00.000000",
 "doctype": "DocType",
 "engine": "InnoDB",
 "field_order": [
  "item_name",
  "found_location",
  "found_date",
  "column_break_1",
  "status",
  "finder",
  "section_break_claim",
  "claimant_info",
  "claimed_date"
 ],
 "fields": [
  {
   "fieldname": "item_name",
   "fieldtype": "Data",
   "in_list_view": 1,
   "label": "Item Name",
   "reqd": 1
  },
  {
   "fieldname": "found_location",
   "fieldtype": "Link",
   "label": "Found Location (Room)",
   "options": "Hotel Room"
  },
  {
   "default": "Today",
   "fieldname": "found_date",
   "fieldtype": "Date",
   "label": "Found Date",
   "reqd": 1
  },
  {
   "fieldname": "column_break_1",
   "fieldtype": "Column Break"
  },
  {
   "default": "Found",
   "fieldname": "status",
   "fieldtype": "Select",
   "in_list_view": 1,
   "label": "Status",
   "options": "Found\nClaimed\nDisposed",
   "reqd": 1
  },
  {
   "fieldname": "finder",
   "fieldtype": "Data",
   "label": "Finder Name"
  },
  {
   "fieldname": "section_break_claim",
   "fieldtype": "Section Break",
   "label": "Claim Details"
  },
  {
   "depends_on": "eval:doc.status=='Claimed'",
   "fieldname": "claimant_info",
   "fieldtype": "Text",
   "label": "Claimant Info"
  },
  {
   "depends_on": "eval:doc.status=='Claimed'",
   "fieldname": "claimed_date",
   "fieldtype": "Date",
   "label": "Claimed Date"
  }
 ],
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-01-28 10:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Hotel Room Type",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  }
 ],
 "sort_field": "modified",
 "sort_order": "DESC",
 "track_changes": 1
}

------------------------------------------------------------
File: lost_and_found_item.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.model.document import Document
from frappe.utils import getdate, nowdate

class LostAndFoundItem(Document):
    def validate(self):
        self.validate_dates()
        self.validate_claim()

    def validate_dates(self):
        if getdate(self.found_date) > getdate(nowdate()):
            frappe.throw(_("Found Date cannot be in the future."))

    def validate_claim(self):
        if self.status == "Claimed":
            if not self.claimant_info:
                frappe.throw(_("Please enter Claimant Info before marking as Claimed."))
            
            if not self.claimed_date:
                self.claimed_date = nowdate()
            
            if getdate(self.claimed_date) < getdate(self.found_date):
                frappe.throw(_("Claimed Date cannot be before Found Date."))

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/lost_and_found_item/__pycache__
================================================================================

------------------------------------------------------------
File: lost_and_found_item.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/doctype/hotel_room
================================================================================

------------------------------------------------------------
File: hotel_room.json
------------------------------------------------------------
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "field:room_number",
 "creation": "2025-01-28 10:05:00.000000",
 "doctype": "DocType",
 "engine": "InnoDB",
 "field_order": [
  "room_number",
  "room_type",
  "floor",
  "column_break_1",
  "status",
  "is_enabled",
  "warehouse"
 ],
 "fields": [
  {
   "fieldname": "room_number",
   "fieldtype": "Data",
   "label": "Room Number",
   "reqd": 1,
   "unique": 1
  },
  {
   "fieldname": "room_type",
   "fieldtype": "Link",
   "label": "Room Type",
   "options": "Hotel Room Type",
   "reqd": 1
  },
  {
   "fieldname": "floor",
   "fieldtype": "Data",
   "label": "Floor"
  },
  {
   "fieldname": "column_break_1",
   "fieldtype": "Column Break"
  },
  {
   "default": "Available",
   "fieldname": "status",
   "fieldtype": "Select",
   "label": "Status",
   "options": "Available\nOccupied\nDirty\nOut of Order",
   "reqd": 1
  },
  {
   "default": "1",
   "fieldname": "is_enabled",
   "fieldtype": "Check",
   "label": "Is Enabled"
  },
  {
   "fieldname": "warehouse",
   "fieldtype": "Link",
   "label": "Stock Warehouse",
   "options": "Warehouse",
   "description": "Warehouse used for Minibar consumption deduction"
  }
 ],
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-01-28 10:05:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Hotel Room",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  }
 ],
 "sort_field": "room_number",
 "sort_order": "ASC",
 "track_changes": 1
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


------------------------------------------------------------
File: hotel_room.py
------------------------------------------------------------
from frappe.model.document import Document
class HotelRoom(Document):
    pass


================================================================================
Folder: hospitality_core/doctype/hotel_room/__pycache__
================================================================================

------------------------------------------------------------
File: hotel_room.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/hotel_group_booking
================================================================================

------------------------------------------------------------
File: hotel_group_booking.json
------------------------------------------------------------
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "field:group_name",
 "creation": "2025-01-28 11:40:00.000000",
 "doctype": "DocType",
 "engine": "InnoDB",
 "field_order": [
  "group_name",
  "master_payer",
  "status",
  "column_break_1",
  "arrival_date",
  "departure_date",
  "master_folio"
 ],
 "fields": [
  {
   "fieldname": "group_name",
   "fieldtype": "Data",
   "label": "Group Name",
   "reqd": 1,
   "unique": 1,
   "description": "e.g., 'Smith Wedding 2025' or 'TechConf Delegates'"
  },
  {
   "fieldname": "master_payer",
   "fieldtype": "Link",
   "label": "Master Payer (Customer)",
   "options": "Customer",
   "description": "The Company/Person responsible for the Master Folio."
  },
  {
   "default": "Tentative",
   "fieldname": "status",
   "fieldtype": "Select",
   "label": "Status",
   "options": "Tentative\nConfirmed\nIn House\nChecked Out\nCancelled",
   "reqd": 1
  },
  {
   "fieldname": "column_break_1",
   "fieldtype": "Column Break"
  },
  {
   "fieldname": "arrival_date",
   "fieldtype": "Date",
   "label": "Arrival Date"
  },
  {
   "fieldname": "departure_date",
   "fieldtype": "Date",
   "label": "Departure Date"
  },
  {
   "fieldname": "master_folio",
   "fieldtype": "Link",
   "label": "Master Folio",
   "options": "Guest Folio",
   "read_only": 1,
   "description": "Created automatically when the Group checks in."
  }
 ],
 "index_web_pages_for_search": 1,
 "links": [
  {
   "link_doctype": "Hotel Reservation",
   "link_fieldname": "group_booking"
  }
 ],
 "modified": "2025-01-28 11:40:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Hotel Group Booking",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "read": 1,
   "write": 1,
   "role": "System Manager"
  },
  {
   "create": 1,
   "read": 1,
   "write": 1,
   "role": "Hospitality User"
  }
 ],
 "sort_field": "modified",
 "sort_order": "DESC",
 "track_changes": 1
}

------------------------------------------------------------
File: hotel_group_booking.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.model.document import Document
from frappe.utils import getdate

class HotelGroupBooking(Document):
    def validate(self):
        self.validate_dates()
        self.validate_status()

    def validate_dates(self):
        if self.arrival_date and self.departure_date:
            if getdate(self.arrival_date) >= getdate(self.departure_date):
                frappe.throw(_("Departure Date must be after Arrival Date."))

    def validate_status(self):
        # Prevent checking in a group without a financial master folio
        if self.status in ["In House", "Checked Out"] and not self.master_folio:
            frappe.throw(
                _("Cannot change status to '{0}' until a Master Folio is created. Please click 'Create Master Folio'.").format(self.status)
            )

        # If Status is Confirmed, Master Payer is mandatory
        if self.status == "Confirmed" and not self.master_payer:
            frappe.throw(_("Please select a Master Payer (Customer) to confirm this group booking."))

------------------------------------------------------------
File: hotel_group_booking.js
------------------------------------------------------------
frappe.ui.form.on('Hotel Group Booking', {
    refresh: function (frm) {
        if (!frm.is_new()) {

            // Button: Create Master Folio
            if (!frm.doc.master_folio) {
                frm.add_custom_button(__('Create Master Folio'), function () {
                    frm.call({
                        method: 'hospitality_core.hospitality_core.api.group_booking.create_master_folio',
                        args: { group_booking_name: frm.doc.name },
                        freeze: true,
                        callback: function (r) {
                            if (!r.exc) frm.reload_doc();
                        }
                    });
                }).addClass("btn-primary");
            } else {
                // Link to Folio
                frm.add_custom_button(__('View Master Folio'), function () {
                    frappe.set_route('Form', 'Guest Folio', frm.doc.master_folio);
                });
            }

            // Button: Add Reservations
            frm.add_custom_button(__('Link Reservations'), function () {
                new frappe.ui.form.MultiSelectDialog({
                    doctype: "Hotel Reservation",
                    target: frm,
                    setters: {
                        status: 'Reserved',
                    },
                    get_query() {
                        return {
                            filters: {
                                'group_booking': ['is', 'not set'],
                                'status': 'Reserved'
                            }
                        };
                    },
                    action(selections) {
                        if (selections.length === 0) {
                            frappe.msgprint(__('Please select at least one reservation.'));
                            return;
                        }
                        frm.call({
                            method: 'hospitality_core.hospitality_core.api.group_booking.add_rooms_to_group',
                            args: {
                                group_booking: frm.doc.name,
                                rooms: JSON.stringify(selections)
                            },
                            freeze: true,
                            callback: function (r) {
                                if (!r.exc) {
                                    frappe.msgprint(__('Reservations linked successfully.'));
                                    frm.reload_doc();
                                }
                            }
                        });
                    }
                });
            });

            // Button: Mass Check In
            if (frm.doc.status === 'Confirmed' || frm.doc.status === 'In House') {
                frm.add_custom_button(__('Check In Group'), function () {
                    frappe.confirm('Check In all RESERVED guests in this group?', () => {
                        frm.call({
                            method: 'hospitality_core.hospitality_core.api.group_booking.mass_check_in',
                            args: { group_booking: frm.doc.name },
                            freeze: true,
                            callback: function (r) {
                                if (!r.exc) {
                                    frappe.msgprint(r.message);
                                    frm.reload_doc();
                                }
                            }
                        });
                    });
                }, 'Actions');
            }

            // Button: Mass Check Out
            if (frm.doc.status === 'In House' || frm.doc.status === 'Checked Out') {
                frm.add_custom_button(__('Check Out Group'), function () {
                    frappe.confirm('Check Out all IN-HOUSE guests in this group?', () => {
                        frm.call({
                            method: 'hospitality_core.hospitality_core.api.group_booking.mass_check_out',
                            args: { group_booking: frm.doc.name },
                            freeze: true,
                            callback: function (r) {
                                if (!r.exc) {
                                    frappe.msgprint(r.message);
                                    frm.reload_doc();
                                }
                            }
                        });
                    });
                }, 'Actions');
            }
        }
    }
});

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/hotel_group_booking/__pycache__
================================================================================

------------------------------------------------------------
File: hotel_group_booking.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/guest
================================================================================

------------------------------------------------------------
File: guest.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.model.document import Document

class Guest(Document):
    pass

@frappe.whitelist()
def get_guest_stats(guest):
    # 1. Stays & Last Room
    stays = frappe.get_all("Hotel Reservation", 
        filters={"guest": guest, "status": "Checked Out"},
        fields=["name", "room"],
        order_by="departure_date desc",
        limit=1
    )
    
    total_stays = frappe.db.count("Hotel Reservation", {"guest": guest, "status": "Checked Out"})
    last_room = stays[0].room if stays else None

    # 2. Financials (Total Spend from Closed Folios)
    financials = frappe.db.sql("""
        SELECT SUM(total_charges) as total
        FROM `tabGuest Folio`
        WHERE guest = %s AND status = 'Closed'
    """, (guest,), as_dict=True)[0]
    
    total_spend = financials.total or 0.0
    avg_rate = (total_spend / total_stays) if total_stays else 0

    return {
        "total_stays": total_stays,
        "last_room": last_room,
        "total_spend": total_spend,
        "avg_rate": avg_rate
    }

------------------------------------------------------------
File: guest.json
------------------------------------------------------------
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "format:{full_name}",
 "creation": "2025-01-28 10:30:00.000000",
 "doctype": "DocType",
 "engine": "InnoDB",
 "field_order": [
  "full_name",
  "guest_type",
  "email_id",
  "mobile_no",
  "column_break_1",
  "customer",
  "address",
  "identification_no",
  "identification_type"
 ],
 "fields": [
  {
   "fieldname": "full_name",
   "fieldtype": "Data",
   "in_list_view": 1,
   "label": "Full Name",
   "reqd": 1
  },
  {
   "default": "Regular",
   "fieldname": "guest_type",
   "fieldtype": "Select",
   "in_list_view": 1,
   "label": "Guest Type",
   "options": "Regular\nVIP\nCorporate\nStaff\nBlacklisted",
   "reqd": 1
  },
  {
   "fieldname": "email_id",
   "fieldtype": "Data",
   "label": "Email",
   "options": "Email"
  },
  {
   "fieldname": "mobile_no",
   "fieldtype": "Data",
   "label": "Mobile No"
  },
  {
   "fieldname": "column_break_1",
   "fieldtype": "Column Break"
  },
  {
   "fieldname": "customer",
   "fieldtype": "Link",
   "label": "ERPNext Customer Link",
   "options": "Customer",
   "description": "Required for Corporate Guests to link to Company Billing."
  },
  {
   "fieldname": "address",
   "fieldtype": "Small Text",
   "label": "Address"
  },
  {
   "fieldname": "identification_no",
   "fieldtype": "Data",
   "label": "Identification No"
  },
  {
   "fieldname": "identification_type",
   "fieldtype": "Select",
   "label": "ID Type",
   "options": "\nPassport\nNational ID\nDriver License"
  }
 ],
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-01-28 14:30:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Guest",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  },
  {
   "create": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "Hospitality User",
   "share": 1,
   "write": 1
  }
 ],
 "sort_field": "modified",
 "sort_order": "DESC",
 "track_changes": 1
}

------------------------------------------------------------
File: guest.js
------------------------------------------------------------
frappe.ui.form.on('Guest', {
    refresh: function(frm) {
        if (!frm.is_new()) {
            render_guest_dashboard(frm);
            
            // Add button to jump to history
            frm.add_custom_button(__('View Past Stays'), function() {
                frappe.set_route('List', 'Hotel Reservation', {guest: frm.doc.name});
            }, 'History');
        }
    }
});

function render_guest_dashboard(frm) {
    // 1. Fetch Data
    frappe.call({
        method: 'hospitality_core.hospitality_core.doctype.guest.guest.get_guest_stats',
        args: { guest: frm.doc.name },
        callback: function(r) {
            if (r.message) {
                let stats = r.message;
                
                // 2. Inject HTML
                let html = `
                <div class="row" style="margin-bottom: 20px;">
                    <div class="col-sm-3">
                        <div class="dashboard-stat-box" style="background:#f8f9fa; padding:15px; border-radius:5px; text-align:center;">
                            <h4 style="color:#6c757d;">Total Stays</h4>
                            <h2>${stats.total_stays}</h2>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="dashboard-stat-box" style="background:#e8f5e9; padding:15px; border-radius:5px; text-align:center;">
                            <h4 style="color:#2e7d32;">Total Spend</h4>
                            <h2>${format_currency(stats.total_spend)}</h2>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="dashboard-stat-box" style="background:#e3f2fd; padding:15px; border-radius:5px; text-align:center;">
                            <h4 style="color:#1565c0;">Last Room</h4>
                            <h2>${stats.last_room || '-'}</h2>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="dashboard-stat-box" style="background:#fff3e0; padding:15px; border-radius:5px; text-align:center;">
                            <h4 style="color:#ef6c00;">Avg. Rate</h4>
                            <h2>${format_currency(stats.avg_rate)}</h2>
                        </div>
                    </div>
                </div>
                `;
                
                // Inject before the first section
                if(frm.fields_dict['full_name']) {
                    $(frm.fields_dict['full_name'].wrapper).closest('.form-section').before(html);
                }
            }
        }
    });
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/guest/__pycache__
================================================================================

------------------------------------------------------------
File: guest.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/hotel_reservation
================================================================================

------------------------------------------------------------
File: hotel_reservation.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.model.document import Document
from frappe.utils import getdate, nowdate, add_days, flt
from hospitality_core.hospitality_core.api.reservation import check_availability, create_folio
# Imports for immediate billing logic
from hospitality_core.hospitality_core.api.night_audit import post_room_charge, get_rate, already_charged_today

class HotelReservation(Document):
    def validate(self):
        self.validate_dates()
        
        # Only validate availability if status is Reserved or being created (not when cancelling or checking out)
        if self.status == "Reserved" and not self.is_new():
            self.validate_room_availability()
        
        # Requirement: "billing to Company should be set... Folio is opened to the Company"
        # New Requirement: If Is Company Guest is checked, Company is mandatory
        if self.is_company_guest and not self.company:
            frappe.throw(_("Company is mandatory when 'Is Company Guest' is checked."))

        if self.company:
            self.ensure_company_folio()

    def validate_dates(self):
        if getdate(self.arrival_date) >= getdate(self.departure_date):
            frappe.throw(_("Departure Date must be after Arrival Date."))

    def validate_room_availability(self):
        check_availability(
            room=self.room, 
            arrival_date=self.arrival_date, 
            departure_date=self.departure_date, 
            ignore_reservation=self.name
        )

    def after_insert(self):
        # Requirement: "And a Folio is also opened for the guest"
        create_folio(self)

    def ensure_company_folio(self):
        """
        Ensures an OPEN Master Folio exists for the Company.
        Company Folios are indefinite and manually closed.
        """
        if not self.company:
            return

        # Check for existing Open Master Folio for this Company
        exists = frappe.db.exists("Guest Folio", {
            "company": self.company,
            "status": "Open",
            "is_company_master": 1
        })

        if not exists:
            # Create Master Company Folio
            guest_name = self.get_corporate_guest_name()
            
            folio = frappe.new_doc("Guest Folio")
            folio.is_company_master = 1 # Flag as Company Folio
            folio.guest = guest_name
            folio.company = self.company
            folio.status = "Open"
            folio.open_date = nowdate()
            # No specific reservation/room link for Master Folio
            folio.insert(ignore_permissions=True)
            frappe.msgprint(_("Created new Master Folio for Company: {0}").format(self.company))

    def get_corporate_guest_name(self):
        """
        Gets or creates a Representative Guest record for the Company to attach the Master Folio to.
        """
        g_name = frappe.db.get_value("Guest", {"customer": self.company}, "name")
        if not g_name:
            # Create a placeholder guest for the company
            cust = frappe.get_doc("Customer", self.company)
            g = frappe.new_doc("Guest")
            g.full_name = cust.customer_name + " (Master Rep)"
            g.customer = self.company
            g.guest_type = "Corporate"
            g.insert(ignore_permissions=True)
            g_name = g.name
        return g_name

    def process_check_in(self):
        """
        Transition: Reserved -> Checked In
        Room: Available -> Occupied
        Folio: Provisional -> Open
        Action: CHARGE FIRST NIGHT IMMEDIATELY
        """
        if self.status != "Reserved":
            frappe.throw(_("Only Reserved bookings can be Checked In."))
        
        if getdate(self.arrival_date) > getdate(nowdate()):
            frappe.throw(_("Cannot Check-In before Arrival Date."))

        # 1. Update Reservation
        self.db_set("status", "Checked In")
        
        # 2. Update Room Status
        frappe.db.set_value("Hotel Room", self.room, "status", "Occupied")
        
        # 3. Update Folio Status
        if self.folio:
            frappe.db.set_value("Guest Folio", self.folio, "status", "Open")

            # 4. IMMEDIATE CHARGE
            # Check if already charged to prevent double billing if Check-in happens twice or after audit
            if not already_charged_today(self.folio, nowdate()):
                rate = get_rate(self.rate_plan, self.room_type, nowdate())
                if rate > 0:
                    # post_room_charge will check self.is_company_guest/is_group_guest to determine billing
                    post_room_charge(self, rate, nowdate())
                    frappe.msgprint(_("Check-in successful. Room charged {0} for today.").format(rate))

        return "Checked In"

    def process_check_out(self):
        """
        Transition: Checked In -> Checked Out
        Room: Occupied -> Dirty
        Folio: Validate Balance -> Closed -> SUBMITTED (Immutable)
        Reservation: SUBMITTED (Immutable)
        """
        if self.status != "Checked In":
            frappe.throw(_("Guest is not currently Checked In."))

        if getdate(self.departure_date) != getdate(nowdate()):
            frappe.throw(_("Cannot Check Out. Departure date ({0}) must be today ({1}).").format(self.departure_date, nowdate()))

        # 1. Handle Folio
        if self.folio:
            folio_doc = frappe.get_doc("Guest Folio", self.folio)
            
            # --- START: AUTOMATIC TRANSFER TO CITY LEDGER ---
            if self.company:
                # Calculate total amount tagged as 'Bill To Company' on this folio
                company_liability = frappe.db.sql("""
                    SELECT SUM(amount) FROM `tabFolio Transaction`
                    WHERE parent = %s 
                    AND bill_to = 'Company' 
                    AND is_void = 0
                """, (self.folio,), as_dict=False)[0][0] or 0.0

                if company_liability > 0:
                    # Check if we already posted a transfer to avoid double credit if button clicked twice
                    transfer_item = "TRANSFER"
                    if not frappe.db.exists("Item", transfer_item):
                        item = frappe.new_doc("Item")
                        item.item_code = transfer_item
                        item.item_name = "Transfer to City Ledger"
                        item.item_group = "Services"
                        item.is_stock_item = 0
                        item.insert(ignore_permissions=True)
                    
                    transfer_exists = frappe.db.exists("Folio Transaction", {
                        "parent": self.folio,
                        "item": transfer_item,
                        "posting_date": nowdate(),
                        "amount": -1 * flt(company_liability)
                    })

                    if not transfer_exists:
                        # Create the Credit Transaction on Guest Folio
                        # This zeros out the Company portion on the Guest's view
                        frappe.get_doc({
                            "doctype": "Folio Transaction",
                            "parent": self.folio,
                            "parenttype": "Guest Folio",
                            "parentfield": "transactions",
                            "posting_date": nowdate(),
                            "item": transfer_item,
                            "description": f"Transfer to Master Folio (City Ledger) - {self.company}",
                            "qty": 1,
                            "amount": -1 * flt(company_liability), # Credit
                            "bill_to": "Company",
                            "is_void": 0
                        }).insert(ignore_permissions=True)
                        
                        frappe.msgprint(_("Transferred {0} to City Ledger.").format(company_liability))
            # --- END: AUTOMATIC TRANSFER ---

            # --- START: AUTOMATIC TRANSFER TO GROUP MASTER ---
            if self.is_group_guest and self.group_booking:
                # 1. Get Group Master Folio ID
                group_master_folio = frappe.db.get_value("Hotel Group Booking", self.group_booking, "master_folio")
                
                if group_master_folio:
                    # 2. Calculate total liability on Guest Folio (excluding existing transfers)
                    # We assume ALL charges go to Group Master if 'Is Group Guest' is checked.
                    # Or we should calculate balance? Let's take the Outstanding Balance.
                    
                    # Re-sync balance first
                    from hospitality_core.hospitality_core.api.folio import sync_folio_balance
                    sync_folio_balance(folio_doc)
                    current_balance = frappe.db.get_value("Guest Folio", self.folio, "outstanding_balance")
                    
                    if current_balance > 0:
                        transfer_item = "TRANSFER-GROUP"
                        if not frappe.db.exists("Item", transfer_item):
                            item = frappe.new_doc("Item")
                            item.item_code = transfer_item
                            item.item_name = "Transfer to Group Master"
                            item.item_group = "Services"
                            item.is_stock_item = 0
                            item.insert(ignore_permissions=True)
                            
                        # 3. Credit Guest Folio
                        frappe.get_doc({
                            "doctype": "Folio Transaction",
                            "parent": self.folio,
                            "parenttype": "Guest Folio",
                            "parentfield": "transactions",
                            "posting_date": nowdate(),
                            "item": transfer_item,
                            "description": f"Transfer to Group Master - {self.group_booking}",
                            "qty": 1,
                            "amount": -1 * flt(current_balance), # Credit
                            "bill_to": "Group",
                            "is_void": 0
                        }).insert(ignore_permissions=True)
                        
                        # 4. Debit Group Master Folio
                        frappe.get_doc({
                            "doctype": "Folio Transaction",
                            "parent": group_master_folio,
                            "parenttype": "Guest Folio",
                            "parentfield": "transactions",
                            "posting_date": nowdate(),
                            "item": transfer_item,
                            "description": f"Charge from Room {self.room} ({self.guest_name})",
                            "qty": 1,
                            "amount": flt(current_balance), # Debit
                            "is_void": 0
                        }).insert(ignore_permissions=True)
                        
                        frappe.msgprint(_("Transferred {0} to Group Master Folio.").format(current_balance))
            # --- END: AUTOMATIC TRANSFER TO GROUP MASTER ---
            
            # Recalculate balance to be safe
            from hospitality_core.hospitality_core.api.folio import sync_folio_balance
            sync_folio_balance(folio_doc)
            
            # Re-fetch values
            balance = frappe.db.get_value("Guest Folio", self.folio, "outstanding_balance")
            
            # Requirement: "folio once opened cannot be closed until all payments are made... enforced... for private guests"
            # Updated Requirement: Company Guests can check out with balance.
            
            if not self.is_company_guest:
                if balance > 0.01 or balance < -0.01:
                    frappe.throw(_("Cannot Check Out. Outstanding balance of {0} remains on Folio {1}. Please settle payment.").format(balance, self.folio))
            else:
                if balance > 0.01:
                    frappe.msgprint(_("Company Guest Checkout: Outstanding balance of {0}. Liability remains on Company Master Folio.").format(balance))
            
            # Close Folio
            folio_doc.db_set("status", "Closed")
            folio_doc.db_set("close_date", nowdate())
            
            # Requirement: "folio ... should be submitted and immutable"
            # Updated: Document is no longer submittable.
            folio_doc.save()

        # 2. Update Reservation
        self.db_set("status", "Checked Out")
        
        # 3. Update Room Status to Dirty
        frappe.db.set_value("Hotel Room", self.room, "status", "Dirty")

        # 4. Doctype is no longer submittable, just save changes.
        self.save()

        return "Checked Out"
    
    def process_cancel(self):
        """
        Transition: Reserved -> Cancelled
        """
        if self.status != "Reserved":
            frappe.throw(_("Only Reserved bookings can be Cancelled."))
        
        self.db_set("status", "Cancelled")
        
        # If there's a folio, cancel it as well if it's not already closed
        if self.folio:
            folio_status = frappe.db.get_value("Guest Folio", self.folio, "status")
            if folio_status not in ["Closed", "Cancelled"]:
                frappe.db.set_value("Guest Folio", self.folio, "status", "Cancelled")
                frappe.msgprint(_("Linked Guest Folio {0} has been cancelled.").format(self.folio))
        
        return "Cancelled"

# Whitelisted methods for client-side buttons
@frappe.whitelist()
def check_in_guest(name):
    doc = frappe.get_doc("Hotel Reservation", name)
    return doc.process_check_in()

@frappe.whitelist()
def check_out_guest(name):
    doc = frappe.get_doc("Hotel Reservation", name)
    return doc.process_check_out()

@frappe.whitelist()
def cancel_reservation(name):
    doc = frappe.get_doc("Hotel Reservation", name)
    return doc.process_cancel()

------------------------------------------------------------
File: test_hotel_reservation.py
------------------------------------------------------------
# Copyright (c) 2025, 	Gift Braimah and Contributors
# See license.txt

# import frappe
from frappe.tests.utils import FrappeTestCase


class TestHotelReservation(FrappeTestCase):
	pass


------------------------------------------------------------
File: hotel_reservation_list.js
------------------------------------------------------------
frappe.listview_settings['Hotel Reservation'] = {
    add_fields: ["status"],
    get_indicator: function (doc) {
        var colors = {
            "Reserved": "orange",
            "Checked In": "green",
            "Checked Out": "gray",
            "Cancelled": "red"
        };
        return [__(doc.status), colors[doc.status] || "grey", "status,=," + doc.status];
    }
};


------------------------------------------------------------
File: hotel_reservation.js
------------------------------------------------------------
frappe.ui.form.on('Hotel Reservation', {
    refresh: function (frm) {
        // Filter Rooms based on Room Type AND Availability
        frm.set_query('room', function () {
            return {
                query: 'hospitality_core.hospitality_core.api.reservation.get_available_rooms_for_picker',
                filters: {
                    'arrival_date': frm.doc.arrival_date,
                    'departure_date': frm.doc.departure_date,
                    'room_type': frm.doc.room_type,
                    'ignore_reservation': frm.doc.name
                }
            };
        });

        // Add Workflow Buttons
        if (!frm.is_new()) {

            // CHECK IN BUTTON
            if (frm.doc.status === 'Reserved') {
                frm.add_custom_button(__('Check In'), function () {
                    frappe.confirm(
                        'Are you sure you want to Check In this guest?',
                        function () {
                            frm.call({
                                method: 'check_in_guest',
                                args: {
                                    name: frm.doc.name
                                },
                                freeze: true,
                                callback: function (r) {
                                    if (!r.exc) {
                                        frappe.msgprint('Guest Checked In Successfully');
                                        frm.reload_doc();
                                    }
                                }
                            });
                        }
                    );
                }).addClass("btn-primary");
            }

            // CHECK OUT BUTTON
            if (frm.doc.status === 'Checked In') {
                frm.add_custom_button(__('Check Out'), function () {
                    if (frm.doc.departure_date !== frappe.datetime.nowdate()) {
                        frappe.msgprint(__('Cannot Check Out. Departure date must be today.'));
                        return;
                    }
                    frappe.confirm(
                        'Are you sure you want to Check Out this guest?',
                        function () {
                            frm.call({
                                method: 'check_out_guest',
                                args: {
                                    name: frm.doc.name
                                },
                                freeze: true,
                                callback: function (r) {
                                    if (!r.exc) {
                                        frappe.msgprint('Guest Checked Out. Room marked as Dirty.');
                                        frm.reload_doc();
                                    }
                                }
                            });
                        }
                    );
                }).addClass("btn-danger");
            }

            // CANCEL RESERVATION BUTTON
            if (frm.doc.status === 'Reserved') {
                frm.add_custom_button(__('Cancel Reservation'), function () {
                    frappe.confirm(
                        'Are you sure you want to Cancel this Reservation?',
                        function () {
                            frm.call({
                                method: 'cancel_reservation',
                                args: {
                                    name: frm.doc.name
                                },
                                freeze: true,
                                callback: function (r) {
                                    if (!r.exc) {
                                        frappe.msgprint('Reservation Cancelled.');
                                        frm.reload_doc();
                                    }
                                }
                            });
                        }
                    );
                }, __('Actions'));
            }

            // Quick Access to Folio
            if (frm.doc.folio) {
                frm.add_custom_button(__('Open Folio'), function () {
                    frappe.set_route('Form', 'Guest Folio', frm.doc.folio);
                }, 'View');
            }

            // Readonly if Checked Out
            if (frm.doc.status === 'Checked Out' || frm.doc.status === 'Cancelled') {
                frm.set_read_only();
                frm.set_df_property('departure_date', 'read_only', 1);
            }
        }
        // ROOM MOVE BUTTON
        if (frm.doc.status === 'Checked In') {
            frm.add_custom_button(__('Move Room'), function () {

                var d = new frappe.ui.Dialog({
                    title: 'Move Guest to New Room',
                    fields: [
                        {
                            label: 'New Room',
                            fieldname: 'new_room',
                            fieldtype: 'Link',
                            options: 'Hotel Room',
                            get_query: function () {
                                return {
                                    filters: {
                                        'status': 'Available',
                                        'is_enabled': 1,
                                        'name': ['!=', frm.doc.room]
                                    }
                                };
                            },
                            reqd: 1
                        }
                    ],
                    primary_action_label: 'Move',
                    primary_action: function (values) {
                        frm.call({
                            method: 'hospitality_core.hospitality_core.api.room_move.process_room_move',
                            args: {
                                reservation_name: frm.doc.name,
                                new_room: values.new_room
                            },
                            freeze: true,
                            callback: function (r) {
                                if (!r.exc) {
                                    d.hide();
                                    frm.reload_doc();
                                }
                            }
                        });
                    }
                });
                d.show();

            }, 'Actions');
        }
    },

    room_type: function (frm) {
        // Clear room if type changes
        frm.set_value('room', '');
    },

    arrival_date: function (frm) {
        calculate_nights(frm);
        validate_room_availability(frm);
    },

    departure_date: function (frm) {
        calculate_nights(frm);
        validate_room_availability(frm);
    }
});

function calculate_nights(frm) {
    if (frm.doc.arrival_date && frm.doc.departure_date) {
        var diff = frappe.datetime.get_diff(frm.doc.departure_date, frm.doc.arrival_date);
        if (diff < 1) {
            frappe.msgprint("Departure must be after Arrival");
        }
    }
}

function validate_room_availability(frm) {
    if (frm.doc.room && frm.doc.arrival_date && frm.doc.departure_date) {
        frappe.call({
            method: "hospitality_core.hospitality_core.api.reservation.check_availability",
            args: {
                room: frm.doc.room,
                arrival_date: frm.doc.arrival_date,
                departure_date: frm.doc.departure_date,
                ignore_reservation: frm.doc.name
            },
            callback: function (r) {
                if (r.exc) {
                    frm.set_value('room', '');
                }
            }
        });
    }
}

------------------------------------------------------------
File: hotel_reservation.json
------------------------------------------------------------
{
    "actions": [],
    "autoname": "naming_series:",
    "creation": "2025-01-28 10:50:00",
    "doctype": "DocType",
    "engine": "InnoDB",
    "field_order": [
        "naming_series",
        "guest",
        "room_type",
        "room",
        "column_break_1",
        "status",
        "folio",
        "arrival_date",
        "departure_date",
        "section_break_financial",
        "rate_plan",
        "is_complimentary",
        "discount_type",
        "discount_value",
        "is_company_guest",
        "company",
        "routing_instructions",
        "amended_from"
    ],
    "fields": [
        {
            "default": "HR-.YYYY.-",
            "fieldname": "naming_series",
            "fieldtype": "Data",
            "label": "Naming Series",
            "no_copy": 1,
            "reqd": 1
        },
        {
            "fieldname": "guest",
            "fieldtype": "Link",
            "in_list_view": 1,
            "label": "Guest",
            "options": "Guest",
            "reqd": 1,
            "set_only_once": 1
        },
        {
            "fieldname": "room_type",
            "fieldtype": "Link",
            "label": "Room Type",
            "options": "Hotel Room Type",
            "reqd": 1,
            "set_only_once": 1
        },
        {
            "fieldname": "room",
            "fieldtype": "Link",
            "label": "Room",
            "options": "Hotel Room",
            "reqd": 1,
            "set_only_once": 1
        },
        {
            "fieldname": "column_break_1",
            "fieldtype": "Column Break"
        },
        {
            "default": "Reserved",
            "fieldname": "status",
            "fieldtype": "Select",
            "in_list_view": 1,
            "label": "Booking Status",
            "options": "Reserved\nChecked In\nChecked Out\nCancelled",
            "read_only": 1,
            "reqd": 1
        },
        {
            "fieldname": "arrival_date",
            "fieldtype": "Date",
            "in_list_view": 1,
            "label": "Arrival Date",
            "reqd": 1,
            "set_only_once": 1
        },
        {
            "fieldname": "departure_date",
            "fieldtype": "Date",
            "in_list_view": 1,
            "label": "Departure Date",
            "reqd": 1
        },
        {
            "fieldname": "section_break_financial",
            "fieldtype": "Section Break",
            "label": "Financial & Routing"
        },
        {
            "fieldname": "rate_plan",
            "fieldtype": "Link",
            "label": "Rate Plan",
            "options": "Room Rate Plan",
            "set_only_once": 1
        },
        {
            "default": "0",
            "fieldname": "is_complimentary",
            "fieldtype": "Check",
            "label": "Complimentary (Free Stay)",
            "set_only_once": 1
        },
        {
            "depends_on": "eval:doc.is_complimentary==0",
            "fieldname": "discount_type",
            "fieldtype": "Select",
            "label": "Discount Type",
            "options": "\nPercentage\nAmount",
            "set_only_once": 1
        },
        {
            "depends_on": "eval:doc.is_complimentary==0 && doc.discount_type",
            "fieldname": "discount_value",
            "fieldtype": "Currency",
            "label": "Discount Value",
            "set_only_once": 1
        },
        {
            "default": "0",
            "fieldname": "is_company_guest",
            "fieldtype": "Check",
            "label": "Is Company Guest",
            "description": "If checked, all charges are automatically mirrored to the Company Master Folio.",
            "set_only_once": 1
        },
        {
            "default": "0",
            "fieldname": "is_group_guest",
            "fieldtype": "Check",
            "label": "Is Group Guest",
            "description": "If checked, all charges are routed to the Group Master Folio.",
            "set_only_once": 1
        },
        {
            "fieldname": "group_booking",
            "fieldtype": "Link",
            "label": "Group Booking",
            "options": "Hotel Group Booking",
            "mandatory_depends_on": "eval:doc.is_group_guest==1"
        },
        {
            "fieldname": "company",
            "fieldtype": "Link",
            "label": "Company",
            "options": "Customer",
            "mandatory_depends_on": "eval:doc.is_company_guest==1",
            "set_only_once": 1
        },
        {
            "fieldname": "routing_instructions",
            "fieldtype": "Table",
            "label": "Routing Instructions",
            "options": "Reservation Routing",
            "set_only_once": 1
        },
        {
            "fieldname": "folio",
            "fieldtype": "Link",
            "label": "Folio",
            "options": "Guest Folio",
            "read_only": 1
        },
        {
            "fieldname": "amended_from",
            "fieldtype": "Link",
            "label": "Amended From",
            "no_copy": 1,
            "options": "Hotel Reservation",
            "read_only": 1
        }
    ],
    "index_web_pages_for_search": 1,
    "is_submittable": 0,
    "links": [],
    "modified": "2025-01-28 14:00:00.000000",
    "modified_by": "Administrator",
    "module": "Hospitality Core",
    "name": "Hotel Reservation",
    "owner": "Administrator",
    "permissions": [
        {
            "create": 1,
            "delete": 1,
            "email": 1,
            "export": 1,
            "print": 1,
            "read": 1,
            "report": 1,
            "role": "System Manager",
            "share": 1,
            "submit": 1,
            "write": 1
        },
        {
            "create": 1,
            "email": 1,
            "export": 1,
            "print": 1,
            "read": 1,
            "report": 1,
            "role": "Hospitality User",
            "share": 1,
            "submit": 1,
            "write": 1
        }
    ],
    "row_format": "Dynamic",
    "sort_field": "modified",
    "sort_order": "DESC",
    "search_fields": "guest,room",
    "states": [],
    "track_changes": 1
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/hotel_reservation/__pycache__
================================================================================

------------------------------------------------------------
File: hotel_reservation.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/folio_transaction
================================================================================

------------------------------------------------------------
File: folio_transaction.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.model.document import Document

class FolioTransaction(Document):
    def before_insert(self):
        self.validate_parent_status()

    def validate(self):
        self.validate_void_status()
        self.fetch_price_if_missing()

    def validate_parent_status(self):
        if self.parent:
            # Check if parent exists before checking status (for testing isolation)
            if frappe.db.exists("Guest Folio", self.parent):
                parent_status = frappe.db.get_value("Guest Folio", self.parent, "status")
                if parent_status in ["Closed", "Cancelled"]:
                    frappe.throw(_("Cannot add transactions to a {0} Folio.").format(parent_status))

    def validate_void_status(self):
        # Prevent manual un-checking of 'Is Void' via list view or data import
        if self.is_new():
            return

        db_is_void = frappe.db.get_value("Folio Transaction", self.name, "is_void")
        if db_is_void and not self.is_void:
            frappe.throw(_("Cannot un-void a transaction. Create a new correction posting instead."))

    def fetch_price_if_missing(self):
        """
        Requirement: "price should be fetched automatically"
        If Item is selected but Amount is 0, fetch from Item Price (Standard Selling) or Item Standard Rate.
        """
        if self.item and not self.amount and not self.is_void:
            # 1. Try fetching from Item Price List (Standard Selling)
            price = frappe.db.get_value("Item Price", 
                {"item_code": self.item, "price_list": "Standard Selling"}, 
                "price_list_rate"
            )
            
            # 2. Fallback to Item Standard Rate
            if not price:
                price = frappe.db.get_value("Item", self.item, "standard_rate")
            
            if price:
                self.amount = float(price) * (self.qty or 1)
            
            # Auto-fetch description if missing
            if not self.description:
                self.description = frappe.db.get_value("Item", self.item, "item_name")

------------------------------------------------------------
File: folio_transaction.json
------------------------------------------------------------
{
 "actions": [],
 "creation": "2025-01-28 11:00:00.000000",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "posting_date",
  "item",
  "description",
  "qty",
  "amount",
  "bill_to",
  "is_void",
  "void_reason",
  "is_invoiced",
  "reference_doctype",
  "reference_name"
 ],
 "fields": [
  {
   "default": "Today",
   "fieldname": "posting_date",
   "fieldtype": "Date",
   "in_list_view": 1,
   "label": "Date",
   "reqd": 1
  },
  {
   "fieldname": "item",
   "fieldtype": "Link",
   "in_list_view": 1,
   "label": "Item",
   "options": "Item",
   "reqd": 1
  },
  {
   "fieldname": "description",
   "fieldtype": "Data",
   "in_list_view": 1,
   "label": "Description"
  },
  {
   "default": "1",
   "fieldname": "qty",
   "fieldtype": "Float",
   "in_list_view": 1,
   "label": "Qty",
   "reqd": 1
  },
  {
   "fieldname": "amount",
   "fieldtype": "Currency",
   "in_list_view": 1,
   "label": "Amount",
   "reqd": 1
  },
  {
   "default": "Guest",
   "fieldname": "bill_to",
   "fieldtype": "Select",
   "in_list_view": 0,
   "label": "Bill To",
   "options": "Guest\nCompany",
   "reqd": 1
  },
  {
   "default": "0",
   "fieldname": "is_void",
   "fieldtype": "Check",
   "label": "Void"
  },
  {
   "depends_on": "eval:doc.is_void==1",
   "fieldname": "void_reason",
   "fieldtype": "Data",
   "label": "Void Reason"
  },
  {
   "default": "0",
   "fieldname": "is_invoiced",
   "fieldtype": "Check",
   "label": "Billed",
   "read_only": 1
  },
  {
   "fieldname": "reference_doctype",
   "fieldtype": "Link",
   "label": "Reference DocType",
   "options": "DocType",
   "hidden": 1
  },
  {
   "fieldname": "reference_name",
   "fieldtype": "Dynamic Link",
   "label": "Reference ID",
   "options": "reference_doctype",
   "hidden": 1
  }
 ],
 "istable": 1,
 "links": [],
 "modified": "2025-01-28 11:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Folio Transaction",
 "owner": "Administrator",
 "permissions": [],
 "sort_field": "posting_date",
 "sort_order": "ASC",
 "track_changes": 1
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/folio_transaction/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: folio_transaction.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/room_rate_plan
================================================================================

------------------------------------------------------------
File: room_rate_plan.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.model.document import Document
from frappe.utils import getdate

class RoomRatePlan(Document):
    def validate(self):
        self.validate_dates()
        if self.active:
            self.validate_overlap()

    def validate_dates(self):
        if getdate(self.valid_from) > getdate(self.valid_to):
            frappe.throw(_("Valid From date cannot be after Valid To date."))

    def validate_overlap(self):
        """
        Ensure no other Active rate plan exists for this Room Type 
        within the same date range.
        """
        overlapping = frappe.db.sql("""
            SELECT name FROM `tabRoom Rate Plan`
            WHERE room_type = %s
            AND name != %s
            AND active = 1
            AND (
                (valid_from BETWEEN %s AND %s) OR
                (valid_to BETWEEN %s AND %s) OR
                (%s BETWEEN valid_from AND valid_to)
            )
        """, (
            self.room_type, 
            self.name or "New Rate Plan", 
            self.valid_from, self.valid_to, 
            self.valid_from, self.valid_to, 
            self.valid_from
        ))

        if overlapping:
            frappe.throw(
                _("Rate Plan overlaps with existing active plan: {0} for Room Type {1}").format(
                    overlapping[0][0], self.room_type
                )
            )

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


------------------------------------------------------------
File: room_rate_plan.json
------------------------------------------------------------
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "field:plan_name",
 "creation": "2025-01-28 10:45:00.000000",
 "doctype": "DocType",
 "engine": "InnoDB",
 "field_order": [
  "plan_name",
  "room_type",
  "rate",
  "column_break_1",
  "valid_from",
  "valid_to",
  "active"
 ],
 "fields": [
  {
   "fieldname": "plan_name",
   "fieldtype": "Data",
   "label": "Plan Name",
   "reqd": 1,
   "unique": 1
  },
  {
   "fieldname": "room_type",
   "fieldtype": "Link",
   "label": "Room Type",
   "options": "Hotel Room Type",
   "reqd": 1
  },
  {
   "fieldname": "rate",
   "fieldtype": "Currency",
   "label": "Rate (Per Night)",
   "reqd": 1
  },
  {
   "fieldname": "column_break_1",
   "fieldtype": "Column Break"
  },
  {
   "fieldname": "valid_from",
   "fieldtype": "Date",
   "label": "Valid From",
   "reqd": 1
  },
  {
   "fieldname": "valid_to",
   "fieldtype": "Date",
   "label": "Valid To",
   "reqd": 1
  },
  {
   "default": "1",
   "fieldname": "active",
   "fieldtype": "Check",
   "label": "Active"
  }
 ],
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-01-28 10:45:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Room Rate Plan",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "read": 1,
   "write": 1,
   "role": "System Manager"
  }
 ],
 "sort_field": "modified",
 "sort_order": "DESC",
 "track_changes": 1
}

================================================================================
Folder: hospitality_core/doctype/room_rate_plan/__pycache__
================================================================================

------------------------------------------------------------
File: room_rate_plan.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/allowance_reason_code
================================================================================

------------------------------------------------------------
File: allowance_reason_code.py
------------------------------------------------------------
from frappe.model.document import Document
class AllowanceReasonCode(Document):
    pass


------------------------------------------------------------
File: allowance_reason_code.json
------------------------------------------------------------
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "field:reason_code",
 "creation": "2025-01-28 11:45:00.000000",
 "doctype": "DocType",
 "engine": "InnoDB",
 "field_order": [
  "reason_code",
  "description",
  "requires_manager_approval"
 ],
 "fields": [
  {
   "fieldname": "reason_code",
   "fieldtype": "Data",
   "label": "Reason Code",
   "reqd": 1,
   "unique": 1,
   "description": "e.g., 'SRVC-REC' or 'POST-ERR'"
  },
  {
   "fieldname": "description",
   "fieldtype": "Small Text",
   "label": "Description",
   "reqd": 1
  },
  {
   "default": "0",
   "fieldname": "requires_manager_approval",
   "fieldtype": "Check",
   "label": "Requires Manager Approval",
   "description": "If checked, only users with Manager role can authorize this void."
  }
 ],
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-01-28 11:45:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Allowance Reason Code",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "read": 1,
   "write": 1,
   "role": "System Manager"
  },
  {
   "read": 1,
   "role": "Hospitality User"
  }
 ],
 "sort_field": "reason_code",
 "sort_order": "ASC",
 "track_changes": 1
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/allowance_reason_code/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: allowance_reason_code.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/hotel_maintenance_request
================================================================================

------------------------------------------------------------
File: hotel_maintenance_request.json
------------------------------------------------------------
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "format:MNT-{room}-{YYYY}-{MM}-{####}",
 "creation": "2025-01-28 11:20:00.000000",
 "doctype": "DocType",
 "engine": "InnoDB",
 "field_order": [
  "room",
  "issue_type",
  "status",
  "column_break_1",
  "reported_by",
  "creation",
  "section_break_1",
  "description",
  "resolution_notes"
 ],
 "fields": [
  {
   "fieldname": "room",
   "fieldtype": "Link",
   "in_list_view": 1,
   "label": "Room",
   "options": "Hotel Room",
   "reqd": 1
  },
  {
   "fieldname": "issue_type",
   "fieldtype": "Select",
   "in_list_view": 1,
   "label": "Issue Type",
   "options": "Plumbing\nElectrical\nHVAC\nFurniture\nCleaning\nOther",
   "reqd": 1
  },
  {
   "default": "Reported",
   "fieldname": "status",
   "fieldtype": "Select",
   "in_list_view": 1,
   "label": "Status",
   "options": "Reported\nIn Progress\nCompleted\nCancelled",
   "reqd": 1
  },
  {
   "fieldname": "column_break_1",
   "fieldtype": "Column Break"
  },
  {
   "fieldname": "reported_by",
   "fieldtype": "Link",
   "label": "Reported By",
   "options": "User",
   "default": "user"
  },
  {
   "fieldname": "section_break_1",
   "fieldtype": "Section Break"
  },
  {
   "fieldname": "description",
   "fieldtype": "Text",
   "label": "Description of Defect",
   "reqd": 1
  },
  {
   "fieldname": "resolution_notes",
   "fieldtype": "Text",
   "label": "Resolution Notes"
  }
 ],
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-01-28 11:20:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Hotel Maintenance Request",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "read": 1,
   "write": 1,
   "role": "Hospitality User"
  },
  {
   "create": 1,
   "delete": 1,
   "read": 1,
   "write": 1,
   "role": "System Manager"
  }
 ],
 "sort_field": "modified",
 "sort_order": "DESC",
 "track_changes": 1
}

------------------------------------------------------------
File: hotel_maintenance_request.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.model.document import Document

class HotelMaintenanceRequest(Document):
    def validate(self):
        if self.status == "Completed" and not self.resolution_notes:
            frappe.throw(_("Please enter Resolution Notes before marking as Completed."))

    def on_update(self):
        self.update_room_status()

    def update_room_status(self):
        # Only update room status if the room is currently enabled
        if not frappe.db.get_value("Hotel Room", self.room, "is_enabled"):
            return

        current_room_status = frappe.db.get_value("Hotel Room", self.room, "status")

        # Logic: If Request is Open/In Progress, block the room
        if self.status in ["Reported", "In Progress"]:
            if current_room_status != "Out of Order":
                frappe.db.set_value("Hotel Room", self.room, "status", "Out of Order")
                frappe.msgprint(_("Room {0} marked as 'Out of Order' due to maintenance request.").format(self.room))

        # Logic: If Request is Completed, release the room to Housekeeping
        elif self.status == "Completed":
            if current_room_status == "Out of Order":
                frappe.db.set_value("Hotel Room", self.room, "status", "Dirty")
                frappe.msgprint(_("Maintenance Completed. Room {0} marked as 'Dirty' for cleaning.").format(self.room))

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/hotel_maintenance_request/__pycache__
================================================================================

------------------------------------------------------------
File: hotel_maintenance_request.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/hotel_room_type
================================================================================

------------------------------------------------------------
File: hotel_room_type.json
------------------------------------------------------------
{
 "actions": [],
 "allow_rename": 1,
 "autoname": "field:room_type_name",
 "creation": "2025-01-28 10:00:00.000000",
 "doctype": "DocType",
 "engine": "InnoDB",
 "field_order": [
  "room_type_name",
  "default_rate",
  "max_adults",
  "max_children",
  "description"
 ],
 "fields": [
  {
   "fieldname": "room_type_name",
   "fieldtype": "Data",
   "label": "Room Type Name",
   "reqd": 1,
   "unique": 1
  },
  {
   "fieldname": "default_rate",
   "fieldtype": "Currency",
   "label": "Default Rate",
   "reqd": 1
  },
  {
   "default": "2",
   "fieldname": "max_adults",
   "fieldtype": "Int",
   "label": "Max Adults",
   "reqd": 1
  },
  {
   "default": "1",
   "fieldname": "max_children",
   "fieldtype": "Int",
   "label": "Max Children",
   "reqd": 1
  },
  {
   "fieldname": "description",
   "fieldtype": "Small Text",
   "label": "Description"
  }
 ],
 "index_web_pages_for_search": 1,
 "links": [],
 "modified": "2025-01-28 10:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Hotel Room Type",
 "owner": "Administrator",
 "permissions": [
  {
   "create": 1,
   "delete": 1,
   "email": 1,
   "export": 1,
   "print": 1,
   "read": 1,
   "report": 1,
   "role": "System Manager",
   "share": 1,
   "write": 1
  }
 ],
 "sort_field": "modified",
 "sort_order": "DESC",
 "track_changes": 1
}

------------------------------------------------------------
File: hotel_room_type.py
------------------------------------------------------------
from frappe.model.document import Document
class HotelRoomType(Document):
    pass


------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/hotel_room_type/__pycache__
================================================================================

------------------------------------------------------------
File: hotel_room_type.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/reservation_routing
================================================================================

------------------------------------------------------------
File: reservation_routing.py
------------------------------------------------------------
from frappe.model.document import Document
class ReservationRouting(Document):
    pass


------------------------------------------------------------
File: reservation_routing.json
------------------------------------------------------------
{
 "actions": [],
 "creation": "2025-01-28 10:35:00.000000",
 "doctype": "DocType",
 "editable_grid": 1,
 "engine": "InnoDB",
 "field_order": [
  "item_group",
  "bill_to"
 ],
 "fields": [
  {
   "fieldname": "item_group",
   "fieldtype": "Link",
   "in_list_view": 1,
   "label": "Service / Item Group",
   "options": "Item Group",
   "reqd": 1,
   "description": "Select the Item Group (e.g., 'Room Rent' or 'Food') to route."
  },
  {
   "default": "Guest",
   "fieldname": "bill_to",
   "fieldtype": "Select",
   "in_list_view": 1,
   "label": "Bill To",
   "options": "Guest\nCompany",
   "reqd": 1
  }
 ],
 "istable": 1,
 "links": [],
 "modified": "2025-01-28 10:35:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Reservation Routing",
 "owner": "Administrator",
 "permissions": [],
 "sort_field": "modified",
 "sort_order": "DESC",
 "track_changes": 1
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/reservation_routing/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


------------------------------------------------------------
File: reservation_routing.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/doctype/guest_folio
================================================================================

------------------------------------------------------------
File: guest_folio.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.model.document import Document
from frappe.model.naming import make_autoname

class GuestFolio(Document):
    def autoname(self):
        # Different Naming for Company Master Folios
        if self.is_company_master:
            # e.g., MASTER-GOOGLE
            # We sanitize the company name
            company_key = self.company.replace(" ", "")[:10].upper()
            self.name = make_autoname(f"MASTER-{company_key}-.#####")
        else:
            # Standard Guest Folio: FOLIO-RES-GUEST
            if self.reservation:
                self.name = make_autoname("FOLIO-.#####")
            else:
                self.name = make_autoname("FOLIO-.#####")

    def validate(self):
        self.validate_status_change()
        self.validate_master_folio()

    def validate_master_folio(self):
        if self.is_company_master and not self.company:
            frappe.throw(_("Company is mandatory for a Company Master Folio."))
        
        if not self.is_company_master and not self.reservation:
            # Regular guest folios usually need a reservation
            pass

    def validate_status_change(self):
        if self.status == "Closed":
            # Check if this folio belongs to a Company Guest
            is_company_guest = False
            if self.reservation:
                is_company_guest = frappe.db.get_value("Hotel Reservation", self.reservation, "is_company_guest")
            
            # If it is NOT a company guest, strict balance enforcement applies.
            # If it IS a company guest, we assume the balance is liable to the company and allow closure.
            if not is_company_guest:
                # For Floating Point comparison
                if self.outstanding_balance > 0.01 or self.outstanding_balance < -0.01:
                    frappe.throw(
                        _("Cannot Close Folio. Outstanding Balance is {0}. Please settle payments or post allowances.").format(self.outstanding_balance)
                    )

    def on_trash(self):
        if self.transactions:
            frappe.throw(_("Cannot delete a Folio that has transactions. Cancel it instead."))

------------------------------------------------------------
File: guest_folio.json
------------------------------------------------------------
{
    "actions": [],
    "allow_rename": 1,
    "autoname": "naming_series:",
    "creation": "2025-01-28 11:05:00.000000",
    "doctype": "DocType",
    "engine": "InnoDB",
    "field_order": [
        "naming_series",
        "is_company_master",
        "guest",
        "company",
        "reservation",
        "room",
        "column_break_1",
        "status",
        "open_date",
        "close_date",
        "section_break_1",
        "transactions",
        "section_break_totals",
        "total_charges",
        "total_payments",
        "outstanding_balance",
        "amended_from"
    ],
    "fields": [
        {
            "default": "FOLIO-.#####",
            "fieldname": "naming_series",
            "fieldtype": "Data",
            "label": "Naming Series",
            "no_copy": 1,
            "read_only": 1,
            "reqd": 1
        },
        {
            "default": "0",
            "fieldname": "is_company_master",
            "fieldtype": "Check",
            "label": "Is Company Master Folio",
            "read_only": 1,
            "description": "If checked, this folio stays open indefinitely for corporate billing."
        },
        {
            "fieldname": "guest",
            "fieldtype": "Link",
            "in_list_view": 1,
            "label": "Guest (or Rep)",
            "options": "Guest",
            "read_only": 1,
            "reqd": 0
        },
        {
            "fieldname": "company",
            "fieldtype": "Link",
            "in_list_view": 1,
            "label": "Company",
            "options": "Customer",
            "read_only": 1
        },
        {
            "fieldname": "reservation",
            "fieldtype": "Link",
            "label": "Reservation",
            "options": "Hotel Reservation",
            "read_only": 1,
            "reqd": 0,
            "depends_on": "eval:doc.is_company_master==0"
        },
        {
            "fieldname": "room",
            "fieldtype": "Link",
            "in_list_view": 1,
            "label": "Room",
            "options": "Hotel Room",
            "read_only": 1,
            "depends_on": "eval:doc.is_company_master==0"
        },
        {
            "fieldname": "column_break_1",
            "fieldtype": "Column Break"
        },
        {
            "default": "Provisional",
            "fieldname": "status",
            "fieldtype": "Select",
            "in_list_view": 1,
            "label": "Status",
            "options": "Provisional\nOpen\nClosed\nCancelled",
            "read_only": 1,
            "reqd": 1
        },
        {
            "default": "Today",
            "fieldname": "open_date",
            "fieldtype": "Date",
            "label": "Open Date",
            "read_only": 1
        },
        {
            "fieldname": "close_date",
            "fieldtype": "Date",
            "label": "Close Date",
            "read_only": 1
        },
        {
            "fieldname": "section_break_1",
            "fieldtype": "Section Break",
            "label": "Transactions"
        },
        {
            "fieldname": "transactions",
            "fieldtype": "Table",
            "label": "Transactions",
            "options": "Folio Transaction",
            "read_only": 1,
            "description": "Charges posted to the room will appear here."
        },
        {
            "fieldname": "section_break_totals",
            "fieldtype": "Section Break",
            "label": "Summary"
        },
        {
            "default": "0.0",
            "fieldname": "total_charges",
            "fieldtype": "Currency",
            "label": "Total Charges",
            "read_only": 1
        },
        {
            "default": "0.0",
            "fieldname": "total_payments",
            "fieldtype": "Currency",
            "label": "Total Payments",
            "read_only": 1
        },
        {
            "default": "0.0",
            "fieldname": "outstanding_balance",
            "fieldtype": "Currency",
            "label": "Outstanding Balance",
            "read_only": 1
        },
        {
            "fieldname": "amended_from",
            "fieldtype": "Link",
            "label": "Amended From",
            "no_copy": 1,
            "options": "Guest Folio",
            "read_only": 1
        }
    ],
    "index_web_pages_for_search": 1,
    "is_submittable": 0,
    "links": [],
    "modified": "2025-01-28 11:05:00.000000",
    "modified_by": "Administrator",
    "module": "Hospitality Core",
    "name": "Guest Folio",
    "owner": "Administrator",
    "permissions": [
        {
            "create": 1,
            "delete": 1,
            "email": 1,
            "export": 1,
            "print": 1,
            "read": 1,
            "report": 1,
            "role": "System Manager",
            "share": 1,
            "write": 1
        },
        {
            "create": 1,
            "email": 1,
            "export": 1,
            "print": 1,
            "read": 1,
            "report": 1,
            "role": "Hospitality User",
            "share": 1,
            "write": 1
        }
    ],
    "sort_field": "modified",
    "sort_order": "DESC",
    "track_changes": 1
}

------------------------------------------------------------
File: guest_folio.js
------------------------------------------------------------
frappe.ui.form.on('Guest Folio', {
    refresh: function (frm) {
        frm.set_read_only();

        // Button: Record Payment
        if (frm.doc.status === 'Open' || frm.doc.status === 'Closed') {
            frm.add_custom_button(__('Record Payment'), function () {
                make_payment_entry(frm);
            }, 'Actions');
        }

        // Button: Create Invoice
        if (frm.doc.status !== 'Provisional') {
            frm.add_custom_button(__('Create Invoice'), function () {
                frappe.confirm(
                    'Create Sales Invoice for all unbilled items?',
                    function () {
                        frm.call({
                            method: 'hospitality_core.hospitality_core.api.invoicing.create_invoice_from_folio',
                            args: {
                                folio_name: frm.doc.name
                            },
                            freeze: true,
                            callback: function (r) {
                                if (!r.exc && r.message) {
                                    frappe.msgprint('Invoice Created: ' + r.message);
                                    frappe.set_route('Form', 'Sales Invoice', r.message);
                                    frm.reload_doc();
                                }
                            }
                        });
                    }
                );
            }, 'Actions');
        }

        // Button: Move Transactions (Move Bill)
        if (frm.doc.status === 'Open') {
            frm.add_custom_button(__('Move Transactions'), function () {
                move_transactions_dialog(frm);
            }, 'Actions');
        }

        // Button: Void Transaction
        if (frm.doc.status === 'Open') {
            frm.add_custom_button(__('Void Transaction'), function () {
                void_transaction_dialog(frm);
            }, 'Actions');
        }

        // Highlight Balance
        if (frm.doc.outstanding_balance > 0) {
            frm.set_df_property('outstanding_balance', 'read_only', 1);
            $(frm.fields_dict['outstanding_balance'].wrapper).find('input').css('color', 'red').css('font-weight', 'bold');
        }
    }
});

frappe.ui.form.on('Folio Transaction', {
    item: function (frm, cdt, cdn) {
        // Automatically fetch price when Item is selected
        var row = locals[cdt][cdn];
        if (row.item) {
            frappe.call({
                method: "frappe.client.get_value",
                args: {
                    doctype: "Item Price",
                    filters: { item_code: row.item, price_list: "Standard Selling" }, // Adjust Price List as needed
                    fieldname: "price_list_rate"
                },
                callback: function (r) {
                    let rate = 0;
                    if (r.message && r.message.price_list_rate) {
                        rate = r.message.price_list_rate;
                    } else {
                        // Fallback: Get Standard Rate from Item
                        frappe.db.get_value("Item", row.item, "standard_rate", (val) => {
                            if (val && val.standard_rate) {
                                frappe.model.set_value(cdt, cdn, "amount", val.standard_rate * row.qty);
                            }
                        });
                        return;
                    }
                    frappe.model.set_value(cdt, cdn, "amount", rate * row.qty);
                }
            });

            // Default Description
            frappe.db.get_value("Item", row.item, "item_name", (r) => {
                if (r && r.item_name) frappe.model.set_value(cdt, cdn, "description", r.item_name);
            });
        }
    },

    qty: function (frm, cdt, cdn) {
        var row = locals[cdt][cdn];
        // Recalculate amount if rate known, or simple logic
        // This is a basic implementation. Ideally store rate separately.
    }
});

function move_transactions_dialog(frm) {
    // Filter valid transactions (not void, not invoiced)
    let valid_txns = frm.doc.transactions.filter(t => !t.is_void && !t.is_invoiced).map(t => {
        return { label: `${t.posting_date}: ${t.description} (${t.amount})`, value: t.name }
    });

    if (valid_txns.length === 0) {
        frappe.msgprint("No movable transactions found.");
        return;
    }

    var d = new frappe.ui.Dialog({
        title: 'Move Transactions to Another Folio',
        fields: [
            {
                label: 'Select Transactions',
                fieldname: 'transactions',
                fieldtype: 'MultiSelect', // Or Table MultiSelect depending on version
                options: valid_txns,
                reqd: 1,
                description: 'Ctrl+Click to select multiple'
            },
            {
                label: 'Target Folio',
                fieldname: 'target_folio',
                fieldtype: 'Link',
                options: 'Guest Folio',
                get_query: function () {
                    return {
                        filters: {
                            'status': 'Open',
                            'name': ['!=', frm.doc.name]
                        }
                    };
                },
                reqd: 1
            }
        ],
        primary_action_label: 'Move',
        primary_action: function (values) {
            // MultiSelect returns array of values or comma separated string
            let txn_list = values.transactions;
            if (typeof txn_list === 'string') {
                txn_list = txn_list.split(',').map(s => s.trim());
            }

            frappe.call({
                method: 'hospitality_core.hospitality_core.api.folio.move_transactions',
                args: {
                    transaction_names: txn_list,
                    target_folio: values.target_folio
                },
                freeze: true,
                callback: function (r) {
                    if (!r.exc) {
                        frappe.msgprint(__("Transactions moved successfully"));
                        d.hide();
                        frm.reload_doc();
                    }
                }
            });
        }
    });
    d.show();
}

function void_transaction_dialog(frm) {
    let valid_txns = frm.doc.transactions.filter(t => !t.is_void && !t.is_invoiced).map(t => {
        return { label: `${t.posting_date} - ${t.description} (${t.amount})`, value: t.name }
    });

    if (valid_txns.length === 0) {
        frappe.msgprint("No voidable transactions found.");
        return;
    }

    var d = new frappe.ui.Dialog({
        title: 'Void Transaction',
        fields: [
            {
                label: 'Select Transaction',
                fieldname: 'transaction',
                fieldtype: 'Select',
                options: valid_txns,
                reqd: 1
            },
            {
                label: 'Reason Code',
                fieldname: 'reason',
                fieldtype: 'Link',
                options: 'Allowance Reason Code',
                reqd: 1
            }
        ],
        primary_action_label: 'Void',
        primary_action: function (values) {
            frappe.call({
                method: 'hospitality_core.hospitality_core.api.financial_control.void_transaction',
                args: {
                    folio_transaction_name: values.transaction,
                    reason_code: values.reason
                },
                freeze: true,
                callback: function (r) {
                    if (!r.exc) {
                        d.hide();
                        frm.reload_doc();
                    }
                }
            });
        }
    });
    d.show();
}

function make_payment_entry(frm) {
    frappe.db.get_value('Guest', frm.doc.guest, 'customer').then(r => {
        let customer = frm.doc.company || r.message.customer;

        if (!customer) {
            frappe.msgprint('Please link the Guest to a Customer record first to record payments via ERPNext.');
            return;
        }

        frappe.model.with_doctype('Payment Entry', function () {
            var pe = frappe.model.get_new_doc('Payment Entry');
            pe.payment_type = 'Receive';
            pe.party_type = 'Customer';
            pe.party = customer;
            pe.paid_amount = frm.doc.outstanding_balance;
            pe.received_amount = frm.doc.outstanding_balance;
            pe.reference_no = frm.doc.name;
            pe.reference_date = frappe.datetime.now_date();
            frappe.set_route('Form', 'Payment Entry', pe.name);
        });
    });
}

------------------------------------------------------------
File: guest_folio_list.js
------------------------------------------------------------
frappe.listview_settings['Guest Folio'] = {
    add_fields: ["status"],
    get_indicator: function (doc) {
        var colors = {
            "Provisional": "orange",
            "Open": "green",
            "Closed": "gray",
            "Cancelled": "red"
        };
        return [__(doc.status), colors[doc.status] || "grey", "status,=," + doc.status];
    }
};


------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/doctype/guest_folio/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: guest_folio.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/discount_and_complimentary_report
================================================================================

------------------------------------------------------------
File: discount_and_complimentary_report.py
------------------------------------------------------------
import frappe
from frappe import _

def execute(filters=None):
    columns = [
        {"label": _("Date"), "fieldname": "posting_date", "fieldtype": "Date", "width": 100},
        {"label": _("Type"), "fieldname": "type", "fieldtype": "Data", "width": 120},
        {"label": _("Room"), "fieldname": "room", "fieldtype": "Link", "options": "Hotel Room", "width": 80},
        {"label": _("Guest"), "fieldname": "guest_name", "fieldtype": "Data", "width": 150},
        {"label": _("Item Code"), "fieldname": "item", "fieldtype": "Link", "options": "Item", "width": 120},
        {"label": _("Description"), "fieldname": "description", "fieldtype": "Data", "width": 200},
        {"label": _("Amount (Credit)"), "fieldname": "amount", "fieldtype": "Currency", "width": 120},
        {"label": _("Folio"), "fieldname": "parent", "fieldtype": "Link", "options": "Guest Folio", "width": 140},
        {"label": _("Posted By"), "fieldname": "owner", "fieldtype": "Data", "width": 120}
    ]

    from_date = filters.get("from_date")
    to_date = filters.get("to_date")

    # Logic:
    # Find transactions where amount < 0 (Credits)
    # Exclude Payments (Cash, Card, Transfer)
    # Include Items named 'DISCOUNT', 'COMPLIMENTARY' or Descriptions containing 'Discount'
    
    sql = """
        SELECT
            ft.posting_date,
            CASE 
                WHEN ft.item = 'COMPLIMENTARY' OR ft.description LIKE '%%Complimentary%%' THEN 'Complimentary'
                ELSE 'Discount'
            END as type,
            gf.room,
            g.full_name as guest_name,
            ft.item,
            ft.description,
            ABS(ft.amount) as amount, -- Show as positive value for report legibility
            ft.parent,
            ft.owner
        FROM `tabFolio Transaction` ft
        JOIN `tabGuest Folio` gf ON ft.parent = gf.name
        LEFT JOIN `tabGuest` g ON gf.guest = g.name
        WHERE ft.posting_date BETWEEN %s AND %s
        AND ft.is_void = 0
        AND ft.amount < 0
        AND ft.item NOT IN ('PAYMENT', 'PAYMENT-CASH', 'PAYMENT-CARD') -- Adjust based on your payment item codes
        AND ft.item IN ('DISCOUNT', 'COMPLIMENTARY') 
        OR (ft.amount < 0 AND ft.description LIKE '%%Discount%%' AND ft.item NOT IN ('PAYMENT'))
        ORDER BY ft.posting_date DESC
    """
    
    data = frappe.db.sql(sql, (from_date, to_date), as_dict=True)

    # Chart Data
    comp_total = sum([d['amount'] for d in data if d['type'] == 'Complimentary'])
    disc_total = sum([d['amount'] for d in data if d['type'] == 'Discount'])

    chart = {
        "data": {
            "labels": ["Complimentary", "Discounts"],
            "datasets": [{"name": "Value Given", "values": [comp_total, disc_total]}]
        },
        "type": "bar",
        "colors": ["#e74c3c", "#f39c12"]
    }
    
    if data:
        data.append({
            "description": "<b>TOTAL GIVEN</b>",
            "amount": sum([d['amount'] for d in data])
        })

    return columns, data, None, chart

------------------------------------------------------------
File: discount_and_complimentary_report.js
------------------------------------------------------------
frappe.query_reports["Discount and Complimentary Report"] = {
    "filters": [
        {
            "fieldname": "from_date",
            "label": __("From Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.add_days(frappe.datetime.now_date(), -30),
            "reqd": 1
        },
        {
            "fieldname": "to_date",
            "label": __("To Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        },
        {
            "fieldname": "type",
            "label": __("Type"),
            "fieldtype": "Select",
            "options": ["", "Discount", "Complimentary"],
            "default": ""
        }
    ]
};

------------------------------------------------------------
File: discount_and_complimentary_report.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-28 15:30:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-28 15:30:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Discount and Complimentary Report",
 "owner": "Administrator",
 "ref_doctype": "Guest Folio",
 "report_name": "Discount and Complimentary Report",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "Hospitality Manager"
  },
  {
   "role": "System Manager"
  }
 ]
}

================================================================================
Folder: hospitality_core/report/discount_and_complimentary_report/__pycache__
================================================================================

------------------------------------------------------------
File: discount_and_complimentary_report.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/guest_ledger
================================================================================

------------------------------------------------------------
File: guest_ledger.js
------------------------------------------------------------
frappe.query_reports["Guest Ledger"] = {
    "filters": [
        {
            "fieldname": "show_corporate",
            "label": __("Include Corporate/City Ledger Guests"),
            "fieldtype": "Check",
            "default": 0,
            "description": "If checked, includes guests whose bill is paid by a Company."
        }
    ]
};

------------------------------------------------------------
File: guest_ledger.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-28 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-28 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Guest Ledger",
 "owner": "Administrator",
 "ref_doctype": "Guest Folio",
 "report_name": "Guest Ledger",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: guest_ledger.py
------------------------------------------------------------
import frappe
from frappe import _

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("Room"), "fieldname": "room", "fieldtype": "Link", "options": "Hotel Room", "width": 80},
        {"label": _("Folio ID"), "fieldname": "name", "fieldtype": "Link", "options": "Guest Folio", "width": 140},
        {"label": _("Guest Name"), "fieldname": "guest_name", "fieldtype": "Data", "width": 160},
        {"label": _("Arr Date"), "fieldname": "arrival_date", "fieldtype": "Date", "width": 100},
        {"label": _("Dep Date"), "fieldname": "departure_date", "fieldtype": "Date", "width": 100},
        {"label": _("Charges"), "fieldname": "total_charges", "fieldtype": "Currency", "width": 120},
        {"label": _("Payments"), "fieldname": "total_payments", "fieldtype": "Currency", "width": 120},
        {"label": _("Balance (Guest)"), "fieldname": "outstanding_balance", "fieldtype": "Currency", "width": 120}
    ]

    # Logic:
    # 1. Fetch Open Guest Folios.
    # 2. Requirement: "Guests whose bills are billed to their company is filtered out".
    #    This implies we want the "Private Guest Ledger".
    #    We exclude folios where 'company' field is set (indicating Corporate master billing)
    #    OR we exclude folios where the balance is 0 (fully transferred).
    
    # We allow a filter to toggle this behavior if needed, but default is strict Guest Ledger.
    
    conditions = "gf.status = 'Open'"
    
    # If a guest is purely corporate, they usually have a company linked on the folio.
    # We exclude them to show only "Private" liability.
    if not filters.get("show_corporate"):
        conditions += " AND (gf.company IS NULL OR gf.company = '')"

    sql = f"""
        SELECT
            gf.room,
            gf.name,
            guest.full_name as guest_name,
            res.arrival_date,
            res.departure_date,
            gf.total_charges,
            gf.total_payments,
            gf.outstanding_balance
        FROM
            `tabGuest Folio` gf
        LEFT JOIN
            `tabGuest` guest ON gf.guest = guest.name
        LEFT JOIN
            `tabHotel Reservation` res ON gf.reservation = res.name
        WHERE
            {conditions}
            AND gf.outstanding_balance != 0
        ORDER BY
            gf.room ASC
    """

    data = frappe.db.sql(sql, as_dict=True)
    
    # Add Total Row
    if data:
        total_balance = sum(d.outstanding_balance for d in data)
        data.append({
            "guest_name": "<b>TOTAL RECEIVABLE</b>",
            "outstanding_balance": total_balance
        })

    return columns, data

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/guest_ledger/__pycache__
================================================================================

------------------------------------------------------------
File: guest_ledger.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/city_ledger
================================================================================

------------------------------------------------------------
File: city_ledger.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-12-18 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-12-18 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "City Ledger",
 "owner": "Administrator",
 "ref_doctype": "Sales Invoice",
 "report_name": "City Ledger",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: city_ledger.js
------------------------------------------------------------
frappe.query_reports["City Ledger"] = {
    "filters": [
        {
            "fieldname": "company",
            "label": __("Customer (Company)"),
            "fieldtype": "Link",
            "options": "Customer",
            "reqd": 0
        }
    ],
    "formatter": function(value, row, column, data, default_formatter) {
        value = default_formatter(value, row, column, data);
        
        // Highlight old debts (> 30 days)
        if (column.fieldname === "age" && data && data.age > 30) {
            value = `<span style="color:red; font-weight:bold;">${value}</span>`;
        }
        
        // Highlight negative balances (Credits) in green
        if (column.fieldname === "outstanding_balance" && data && data.outstanding_balance < 0) {
            value = `<span style="color:green;">${value}</span>`;
        }

        return value;
    }
};

------------------------------------------------------------
File: city_ledger.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import nowdate, date_diff

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("Company"), "fieldname": "company", "fieldtype": "Link", "options": "Customer", "width": 160},
        {"label": _("Master Folio"), "fieldname": "name", "fieldtype": "Link", "options": "Guest Folio", "width": 140},
        {"label": _("Open Since"), "fieldname": "open_date", "fieldtype": "Date", "width": 100},
        {"label": _("Age (Days)"), "fieldname": "age", "fieldtype": "Int", "width": 80},
        {"label": _("Guest Ref"), "fieldname": "guest_name", "fieldtype": "Data", "width": 150},
        {"label": _("Total Charges"), "fieldname": "total_charges", "fieldtype": "Currency", "width": 120},
        {"label": _("Payments/Credits"), "fieldname": "total_payments", "fieldtype": "Currency", "width": 120},
        {"label": _("Outstanding Balance"), "fieldname": "outstanding_balance", "fieldtype": "Currency", "width": 140}
    ]

    # Logic: 
    # City Ledger now strictly contains Master Folios (is_company_master = 1).
    # Individual guest folios (even if corporate) are part of Guest Ledger until checked out 
    # and transferred to the City Ledger (Master Folio).
    
    conditions = "gf.status = 'Open' AND gf.is_company_master = 1"
    
    if filters.get("company"):
        conditions += f" AND gf.company = '{filters.get('company')}'"

    sql = f"""
        SELECT
            gf.company,
            gf.name,
            gf.open_date,
            DATEDIFF(CURDATE(), gf.open_date) as age,
            guest.full_name as guest_name,
            gf.total_charges,
            gf.total_payments,
            gf.outstanding_balance
        FROM
            `tabGuest Folio` gf
        LEFT JOIN
            `tabGuest` guest ON gf.guest = guest.name
        WHERE
            {conditions}
            AND gf.outstanding_balance != 0
        ORDER BY
            gf.company, gf.open_date
    """

    data = frappe.db.sql(sql, as_dict=True)
    
    # Add Total Row
    if data:
        total = sum(d.outstanding_balance for d in data)
        data.append({
            "company": "<b>TOTAL CITY LEDGER</b>",
            "outstanding_balance": total
        })
    
    return columns, data

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/city_ledger/__pycache__
================================================================================

------------------------------------------------------------
File: city_ledger.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/house_list
================================================================================

------------------------------------------------------------
File: house_list.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-28 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": "Standard",
 "modified": "2025-01-28 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "House List",
 "owner": "Administrator",
 "prepared_report": 0,
 "ref_doctype": "Hotel Reservation",
 "report_name": "House List",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: house_list.js
------------------------------------------------------------
frappe.query_reports["House List"] = {
    "filters": [
        {
            "fieldname": "date",
            "label": __("Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        }
    ]
};

------------------------------------------------------------
File: house_list.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import getdate, nowdate

def execute(filters=None):
    if not filters:
        filters = {}
        
    target_date = filters.get("date") or nowdate()
    
    columns = [
        {"label": _("Room"), "fieldname": "room", "fieldtype": "Link", "options": "Hotel Room", "width": 80},
        {"label": _("Guest Name"), "fieldname": "guest_name", "fieldtype": "Data", "width": 150},
        {"label": _("Status"), "fieldname": "status", "fieldtype": "Data", "width": 100},
        {"label": _("Arrival"), "fieldname": "arrival_date", "fieldtype": "Date", "width": 100},
        {"label": _("Departure"), "fieldname": "departure_date", "fieldtype": "Date", "width": 100},
        {"label": _("Rate Plan"), "fieldname": "rate_plan", "fieldtype": "Data", "width": 120},
        {"label": _("Pax"), "fieldname": "pax", "fieldtype": "Data", "width": 60, "default": "1"}, # Adults/Children
        {"label": _("Company"), "fieldname": "company", "fieldtype": "Link", "options": "Customer", "width": 150},
        {"label": _("Balance"), "fieldname": "balance", "fieldtype": "Currency", "width": 120}
    ]

    # Logic: 
    # House List = Rooms Occupied on Target Date.
    # Logic: Reservation Arrival <= Target AND Reservation Departure > Target
    # We filter for Status = Checked In (if today) or was active (deduced).
    
    # Note: If looking at the past, strictly relying on current 'Checked In' status is wrong.
    # We must rely on dates.
    # However, 'Checked Out' reservations are also valid for the House List of *yesterday*.
    
    sql = """
        SELECT 
            res.room,
            guest.full_name as guest_name,
            res.status,
            res.arrival_date,
            res.departure_date,
            res.rate_plan,
            res.company,
            folio.outstanding_balance as balance
        FROM
            `tabHotel Reservation` res
        LEFT JOIN
            `tabGuest` guest ON res.guest = guest.name
        LEFT JOIN
            `tabGuest Folio` folio ON res.folio = folio.name
        WHERE
            res.arrival_date <= %(date)s
            AND res.departure_date > %(date)s
            AND res.status IN ('Checked In', 'Checked Out') 
    """
    
    # Note: We include 'Checked Out' because if I run the report for Yesterday, 
    # a guest who checked out Today was "In House" Yesterday.
    # If I run it for Today, 'Checked Out' guests are gone (Departure > Today would be false), 
    # so they are correctly excluded.
    
    data = frappe.db.sql(sql, {"date": target_date}, as_dict=True)
    
    # Add Total Rooms Occupied count
    report_summary = []
    if data:
        report_summary = [
            {"value": len(data), "label": "Total Occupied Rooms", "datatype": "Int"},
        ]

    return columns, data, None, None, report_summary

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/house_list/__pycache__
================================================================================

------------------------------------------------------------
File: house_list.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/folio_balance_summary
================================================================================

------------------------------------------------------------
File: folio_balance_summary.py
------------------------------------------------------------
import frappe
from frappe import _

def execute(filters=None):
    columns = [
        {"label": _("Ledger Type"), "fieldname": "ledger_type", "fieldtype": "Data", "width": 200},
        {"label": _("Description"), "fieldname": "description", "fieldtype": "Data", "width": 300},
        {"label": _("Count"), "fieldname": "count", "fieldtype": "Int", "width": 100},
        {"label": _("Total Receivable"), "fieldname": "balance", "fieldtype": "Currency", "width": 150}
    ]

    data = []

    # 1. Calculate Guest Ledger (In-House Private Guests)
    # Logic: Status Open, Company is Null/Empty
    guest_stats = frappe.db.sql("""
        SELECT COUNT(name) as cnt, SUM(outstanding_balance) as bal
        FROM `tabGuest Folio`
        WHERE status = 'Open' 
        AND (company IS NULL OR company = '')
    """, as_dict=True)[0]

    data.append({
        "ledger_type": "Guest Ledger",
        "description": "Current In-House Guests (Private Pay)",
        "count": guest_stats.cnt or 0,
        "balance": guest_stats.bal or 0.0
    })

    # 2. Calculate City Ledger (Corporate/Direct Bill)
    # Logic: Status Open, Company IS set. 
    # This includes the Master Company Folios created by the new logic.
    city_stats = frappe.db.sql("""
        SELECT COUNT(name) as cnt, SUM(outstanding_balance) as bal
        FROM `tabGuest Folio`
        WHERE status = 'Open' 
        AND company IS NOT NULL 
        AND company != ''
    """, as_dict=True)[0]

    data.append({
        "ledger_type": "City Ledger",
        "description": "Corporate Accounts / Direct Bill Masters",
        "count": city_stats.cnt or 0,
        "balance": city_stats.bal or 0.0
    })

    # 3. Total
    total_bal = (guest_stats.bal or 0) + (city_stats.bal or 0)
    data.append({
        "ledger_type": "<b>TOTAL</b>",
        "description": "",
        "count": (guest_stats.cnt or 0) + (city_stats.cnt or 0),
        "balance": total_bal
    })

    chart = {
        "data": {
            "labels": ["Guest Ledger", "City Ledger"],
            "datasets": [
                {"name": "Balance", "values": [guest_stats.bal or 0, city_stats.bal or 0]}
            ]
        },
        "type": "donut",
        "colors": ["#28a745", "#007bff"]
    }

    return columns, data, None, chart

------------------------------------------------------------
File: folio_balance_summary.js
------------------------------------------------------------
frappe.query_reports["Folio Balance Summary"] = {
    "filters": [
        // This report is primarily a snapshot of the current state.
        // Optional: Add Company filter if multiple hotels exist in one system.
        {
            "fieldname": "company",
            "label": __("Company"),
            "fieldtype": "Link",
            "options": "Company",
            "default": frappe.defaults.get_user_default("Company")
        }
    ],
    "formatter": function(value, row, column, data, default_formatter) {
        value = default_formatter(value, row, column, data);
        
        if (column.fieldname === "balance" && data && data.balance > 0) {
            value = `<span style="color:red; font-weight:bold;">${value}</span>`;
        }
        return value;
    },
    "onload": function(report) {
        // Add a button to jump to detailed ledgers
        report.page.add_inner_button(__("View Guest Ledger"), function() {
            frappe.set_route("query-report", "Guest Ledger");
        });
        report.page.add_inner_button(__("View City Ledger"), function() {
            frappe.set_route("query-report", "City Ledger");
        });
    }
};

------------------------------------------------------------
File: folio_balance_summary.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-28 15:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-28 15:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Folio Balance Summary",
 "owner": "Administrator",
 "ref_doctype": "Guest Folio",
 "report_name": "Folio Balance Summary",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "Hospitality Manager"
  },
  {
   "role": "Accounts User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/folio_balance_summary/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: folio_balance_summary.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/lost_and_found_register
================================================================================

------------------------------------------------------------
File: lost_and_found_register.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-29 13:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-29 13:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Lost and Found Register",
 "owner": "Administrator",
 "ref_doctype": "Lost and Found Item",
 "report_name": "Lost and Found Register",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: lost_and_found_register.py
------------------------------------------------------------
import frappe
from frappe import _

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("ID"), "fieldname": "name", "fieldtype": "Link", "options": "Lost and Found Item", "width": 120},
        {"label": _("Date Found"), "fieldname": "found_date", "fieldtype": "Date", "width": 100},
        {"label": _("Item Name"), "fieldname": "item_name", "fieldtype": "Data", "width": 150},
        {"label": _("Found In"), "fieldname": "found_location", "fieldtype": "Data", "width": 120, "description": "Room or Area"},
        {"label": _("Found By"), "fieldname": "finder_name", "fieldtype": "Data", "width": 120},
        {"label": _("Status"), "fieldname": "status", "fieldtype": "Data", "width": 80},
        {"label": _("Claimed By"), "fieldname": "claimant_info", "fieldtype": "Data", "width": 180},
        {"label": _("Date Claimed"), "fieldname": "claimed_date", "fieldtype": "Date", "width": 100}
    ]

    conditions = "1=1"
    
    if filters.get("from_date") and filters.get("to_date"):
        conditions += f" AND lnf.found_date BETWEEN '{filters.get('from_date')}' AND '{filters.get('to_date')}'"

    if filters.get("status"):
        conditions += f" AND lnf.status = '{filters.get('status')}'"

    sql = f"""
        SELECT
            lnf.name,
            lnf.found_date,
            lnf.item_name,
            lnf.found_location,
            emp.employee_name as finder_name,
            lnf.status,
            lnf.claimant_info,
            lnf.claimed_date
        FROM
            `tabLost and Found Item` lnf
        LEFT JOIN
            `tabEmployee` emp ON lnf.finder = emp.name
        WHERE
            {conditions}
        ORDER BY
            lnf.found_date DESC
    """
    
    data = frappe.db.sql(sql, as_dict=True)
    
    return columns, data

------------------------------------------------------------
File: lost_and_found_register.js
------------------------------------------------------------
frappe.query_reports["Lost and Found Register"] = {
    "filters": [
        {
            "fieldname": "from_date",
            "label": __("Found From"),
            "fieldtype": "Date",
            "default": frappe.datetime.add_days(frappe.datetime.now_date(), -90),
            "reqd": 1
        },
        {
            "fieldname": "to_date",
            "label": __("Found To"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        },
        {
            "fieldname": "status",
            "label": __("Status"),
            "fieldtype": "Select",
            "options": ["", "Found", "Claimed", "Disposed"],
            "default": ""
        }
    ]
};

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/maintenance_log_report
================================================================================

------------------------------------------------------------
File: maintenance_log_report.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-29 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-29 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Maintenance Log Report",
 "owner": "Administrator",
 "ref_doctype": "Hotel Maintenance Request",
 "report_name": "Maintenance Log Report",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "Housekeeping Staff"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: maintenance_log_report.py
------------------------------------------------------------
import frappe
from frappe import _

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("Date Reported"), "fieldname": "creation", "fieldtype": "Date", "width": 100},
        {"label": _("Request ID"), "fieldname": "name", "fieldtype": "Link", "options": "Hotel Maintenance Request", "width": 140},
        {"label": _("Room"), "fieldname": "room", "fieldtype": "Link", "options": "Hotel Room", "width": 80},
        {"label": _("Issue Type"), "fieldname": "issue_type", "fieldtype": "Data", "width": 100},
        {"label": _("Description"), "fieldname": "description", "fieldtype": "Data", "width": 250},
        {"label": _("Reported By"), "fieldname": "reported_by_name", "fieldtype": "Data", "width": 120},
        {"label": _("Status"), "fieldname": "status", "fieldtype": "Data", "width": 100},
        {"label": _("Resolution Notes"), "fieldname": "resolution_notes", "fieldtype": "Data", "width": 200}
    ]

    conditions = "1=1"
    
    if filters.get("from_date") and filters.get("to_date"):
        conditions += f" AND DATE(hmr.creation) BETWEEN '{filters.get('from_date')}' AND '{filters.get('to_date')}'"

    if filters.get("status"):
        conditions += f" AND hmr.status = '{filters.get('status')}'"

    sql = f"""
        SELECT
            DATE(hmr.creation) as creation,
            hmr.name,
            hmr.room,
            hmr.issue_type,
            hmr.description,
            u.full_name as reported_by_name,
            hmr.status,
            hmr.resolution_notes
        FROM
            `tabHotel Maintenance Request` hmr
        LEFT JOIN
            `tabUser` u ON hmr.reported_by = u.name
        WHERE
            {conditions}
        ORDER BY
            hmr.creation DESC
    """
    
    data = frappe.db.sql(sql, as_dict=True)
    
    return columns, data

------------------------------------------------------------
File: maintenance_log_report.js
------------------------------------------------------------
frappe.query_reports["Maintenance Log Report"] = {
    "filters": [
        {
            "fieldname": "from_date",
            "label": __("From Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.add_days(frappe.datetime.now_date(), -30),
            "reqd": 1
        },
        {
            "fieldname": "to_date",
            "label": __("To Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        },
        {
            "fieldname": "status",
            "label": __("Status"),
            "fieldtype": "Select",
            "options": ["", "Reported", "In Progress", "Completed", "Cancelled"],
            "default": ""
        }
    ],
    "formatter": function(value, row, column, data, default_formatter) {
        value = default_formatter(value, row, column, data);
        if (column.fieldname === "status") {
            if (data.status === "Reported") {
                value = `<span style="color:red; font-weight:bold;">${value}</span>`;
            } else if (data.status === "In Progress") {
                value = `<span style="color:orange;">${value}</span>`;
            } else if (data.status === "Completed") {
                value = `<span style="color:green;">${value}</span>`;
            }
        }
        return value;
    }
};

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/void_and_allowance_report
================================================================================

------------------------------------------------------------
File: void_and_allowance_report.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-28 16:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-28 16:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Void and Allowance Report",
 "owner": "Administrator",
 "ref_doctype": "Guest Folio",
 "report_name": "Void and Allowance Report",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "Hospitality Manager"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: void_and_allowance_report.js
------------------------------------------------------------
frappe.query_reports["Void and Allowance Report"] = {
    "filters": [
        {
            "fieldname": "from_date",
            "label": __("From Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        },
        {
            "fieldname": "to_date",
            "label": __("To Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        }
    ]
};

------------------------------------------------------------
File: void_and_allowance_report.py
------------------------------------------------------------
import frappe
from frappe import _

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("Date"), "fieldname": "posting_date", "fieldtype": "Date", "width": 100},
        {"label": _("Folio"), "fieldname": "parent", "fieldtype": "Link", "options": "Guest Folio", "width": 140},
        {"label": _("Room"), "fieldname": "room", "fieldtype": "Data", "width": 80},
        {"label": _("Guest"), "fieldname": "guest_name", "fieldtype": "Data", "width": 150},
        {"label": _("Type"), "fieldname": "type", "fieldtype": "Data", "width": 100},
        {"label": _("Description"), "fieldname": "description", "fieldtype": "Data", "width": 200},
        {"label": _("Amount"), "fieldname": "amount", "fieldtype": "Currency", "width": 120},
        {"label": _("Reason"), "fieldname": "void_reason", "fieldtype": "Data", "width": 150},
        {"label": _("User"), "fieldname": "owner", "fieldtype": "Data", "width": 120}
    ]

    # Filters
    from_date = filters.get("from_date")
    to_date = filters.get("to_date")

    data = []

    # 1. Fetch Voids (Logically deleted/reversed transactions)
    # is_void = 1
    voids = frappe.db.sql("""
        SELECT
            ft.posting_date,
            ft.parent,
            gf.room,
            g.full_name as guest_name,
            'Void' as type,
            ft.description,
            ft.amount, 
            ft.void_reason,
            ft.owner
        FROM `tabFolio Transaction` ft
        JOIN `tabGuest Folio` gf ON ft.parent = gf.name
        LEFT JOIN `tabGuest` g ON gf.guest = g.name
        WHERE ft.posting_date BETWEEN %s AND %s
        AND ft.is_void = 1
    """, (from_date, to_date), as_dict=True)

    # 2. Fetch Allowances/Discounts (Negative amounts, not payments)
    # Exclude Payment Items
    payment_items = frappe.get_all("Item", filters={"item_group": "Payment"}, pluck="name")
    # If using specific codes like PAYMENT-CASH, ensure logic covers it.
    # We look for amounts < 0 AND item NOT IN payment_items
    
    # Also check for "Complimentary" in description or specific Reason Codes
    
    allowances = frappe.db.sql("""
        SELECT
            ft.posting_date,
            ft.parent,
            gf.room,
            g.full_name as guest_name,
            CASE 
                WHEN ft.description LIKE '%%Discount%%' THEN 'Discount'
                WHEN ft.description LIKE '%%Complimentary%%' THEN 'Complimentary'
                ELSE 'Allowance' 
            END as type,
            ft.description,
            ft.amount,
            ft.void_reason,
            ft.owner
        FROM `tabFolio Transaction` ft
        JOIN `tabGuest Folio` gf ON ft.parent = gf.name
        LEFT JOIN `tabGuest` g ON gf.guest = g.name
        WHERE ft.posting_date BETWEEN %s AND %s
        AND ft.is_void = 0
        AND ft.amount < 0
        AND ft.item NOT IN (SELECT name FROM `tabItem` WHERE item_group = 'Payment')
        AND ft.description NOT LIKE '%%Payment%%'
        AND ft.description NOT LIKE '%%Transfer%%'
    """, (from_date, to_date), as_dict=True)

    data = voids + allowances
    
    # Sort by Date
    data.sort(key=lambda x: x['posting_date'])

    # Chart Data
    void_total = sum([d['amount'] for d in voids])
    allowance_total = sum([abs(d['amount']) for d in allowances]) # Display positive for chart
    
    chart = {
        "data": {
            "labels": ["Voids", "Discounts/Allowances"],
            "datasets": [{"name": "Total Impact", "values": [void_total, allowance_total]}]
        },
        "type": "donut"
    }
    
    # Summary Row
    if data:
        data.append({
            "description": "<b>TOTAL IMPACT</b>",
            "amount": sum([d['amount'] for d in data])
        })

    return columns, data, None, chart

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/void_and_allowance_report/__pycache__
================================================================================

------------------------------------------------------------
File: void_and_allowance_report.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/hotel_performance_analytics
================================================================================

------------------------------------------------------------
File: hotel_performance_analytics.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-12-18 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-12-18 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Hotel Performance Analytics",
 "owner": "Administrator",
 "ref_doctype": "Hotel Reservation",
 "report_name": "Hotel Performance Analytics",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: hotel_performance_analytics.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import add_days, date_diff, getdate, flt

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("Date"), "fieldname": "date", "fieldtype": "Date", "width": 110},
        {"label": _("Total Rooms"), "fieldname": "total_rooms", "fieldtype": "Int", "width": 100},
        {"label": _("Occupied"), "fieldname": "occupied_rooms", "fieldtype": "Int", "width": 100},
        {"label": _("Occupancy %"), "fieldname": "occupancy_pct", "fieldtype": "Percent", "width": 110},
        {"label": _("Room Revenue"), "fieldname": "revenue", "fieldtype": "Currency", "width": 130},
        {"label": _("ADR"), "fieldname": "adr", "fieldtype": "Currency", "width": 120, "description": "Average Daily Rate"},
        {"label": _("RevPAR"), "fieldname": "revpar", "fieldtype": "Currency", "width": 120, "description": "Revenue Per Available Room"}
    ]

    data = []
    
    start_date = getdate(filters.get("from_date"))
    end_date = getdate(filters.get("to_date"))
    
    # 1. Total Inventory (Count of enabled rooms)
    total_rooms_count = frappe.db.count("Hotel Room", filters={"is_enabled": 1})

    # 2. Fetch all Room Revenue Transactions in range
    # Grouped by Date
    revenue_map = {}
    rev_sql = """
        SELECT posting_date, SUM(amount) as total
        FROM `tabFolio Transaction`
        WHERE posting_date BETWEEN %s AND %s
        AND is_void = 0
        AND item IN (SELECT name FROM `tabItem` WHERE item_code='ROOM-RENT' OR item_group='Accommodation')
        GROUP BY posting_date
    """
    rev_data = frappe.db.sql(rev_sql, (start_date, end_date), as_dict=True)
    for r in rev_data:
        revenue_map[str(r.posting_date)] = flt(r.total)

    # 3. Loop through dates
    curr_date = start_date
    while curr_date <= end_date:
        str_date = curr_date.strftime("%Y-%m-%d")
        
        # Calculate Occupied
        # Count reservations where Date is within [Arrival, Departure)
        # We explicitly exclude Checked Out if they left BEFORE this date, 
        # but the date range check handles that.
        # Status must be Checked In (for live) or Checked Out (for history).
        occupied_count = frappe.db.count("Hotel Reservation", {
            "arrival_date": ["<=", str_date],
            "departure_date": [">", str_date], 
            "status": ["in", ["Checked In", "Checked Out"]] 
        })

        revenue = revenue_map.get(str_date, 0.0)
        
        # Calculations
        occupancy = (occupied_count / total_rooms_count * 100) if total_rooms_count else 0.0
        adr = (revenue / occupied_count) if occupied_count else 0.0
        revpar = (revenue / total_rooms_count) if total_rooms_count else 0.0

        data.append({
            "date": str_date,
            "total_rooms": total_rooms_count,
            "occupied_rooms": occupied_count,
            "occupancy_pct": flt(occupancy, 2),
            "revenue": revenue,
            "adr": flt(adr, 2),
            "revpar": flt(revpar, 2)
        })

        curr_date = add_days(curr_date, 1)

    # Chart Configuration
    chart = {
        "data": {
            "labels": [d["date"] for d in data],
            "datasets": [
                {"name": "Occupancy %", "values": [d["occupancy_pct"] for d in data]},
                {"name": "RevPAR", "values": [d["revpar"] for d in data]}
            ]
        },
        "type": "line",
        "colors": ["#7cd6fd", "#743ee2"]
    }

    return columns, data, None, chart

------------------------------------------------------------
File: hotel_performance_analytics.js
------------------------------------------------------------
frappe.query_reports["Hotel Performance Analytics"] = {
    "filters": [
        {
            "fieldname": "from_date",
            "label": __("From Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.add_days(frappe.datetime.now_date(), -7),
            "reqd": 1
        },
        {
            "fieldname": "to_date",
            "label": __("To Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        }
    ]
};

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/hotel_performance_analytics/__pycache__
================================================================================

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: hotel_performance_analytics.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/daily_payment_collection
================================================================================

------------------------------------------------------------
File: daily_payment_collection.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-12-18 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-12-18 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Daily Payment Collection",
 "owner": "Administrator",
 "ref_doctype": "Payment Entry",
 "report_name": "Daily Payment Collection",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: daily_payment_collection.py
------------------------------------------------------------
import frappe
from frappe import _

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("Payment Ref"), "fieldname": "name", "fieldtype": "Link", "options": "Payment Entry", "width": 140},
        {"label": _("Date"), "fieldname": "posting_date", "fieldtype": "Date", "width": 100},
        {"label": _("Mode"), "fieldname": "mode_of_payment", "fieldtype": "Data", "width": 120},
        {"label": _("Party"), "fieldname": "party_name", "fieldtype": "Data", "width": 150},
        {"label": _("Folio Ref"), "fieldname": "reference_no", "fieldtype": "Data", "width": 150},
        {"label": _("Amount"), "fieldname": "paid_amount", "fieldtype": "Currency", "width": 120},
        {"label": _("Type"), "fieldname": "payment_type", "fieldtype": "Data", "width": 80}
    ]

    # Filters
    date_from = filters.get("from_date")
    date_to = filters.get("to_date")

    # SQL Logic:
    # 1. Payment Entry must be Submitted (docstatus=1)
    # 2. Match Date Range
    # 3. Match Reference No to Guest Folio naming conventions (FOLIO-xxxxx or MASTER-xxxxx)
    #    OR checks if the reference_no actually exists in the Guest Folio table for robustness.
    
    sql = """
        SELECT
            pe.name,
            pe.posting_date,
            pe.mode_of_payment,
            pe.party_name,
            pe.reference_no,
            pe.paid_amount,
            pe.payment_type
        FROM
            `tabPayment Entry` pe
        WHERE
            pe.docstatus = 1
            AND pe.posting_date BETWEEN %(from_date)s AND %(to_date)s
            AND (
                pe.reference_no LIKE 'FOLIO%%' 
                OR pe.reference_no LIKE 'MASTER%%' 
                OR pe.remarks LIKE '%%Hotel%%'
                OR EXISTS (SELECT 1 FROM `tabGuest Folio` gf WHERE gf.name = pe.reference_no)
            )
        ORDER BY
            pe.mode_of_payment, pe.posting_date
    """

    data = frappe.db.sql(sql, {"from_date": date_from, "to_date": date_to}, as_dict=True)

    # Calculate Totals by Mode
    total_cash = sum(d.paid_amount for d in data if d.mode_of_payment == 'Cash')
    total_card = sum(d.paid_amount for d in data if d.mode_of_payment != 'Cash')
    
    if data:
        data.append({"party_name": "<b>TOTAL CASH</b>", "paid_amount": total_cash})
        data.append({"party_name": "<b>TOTAL OTHER</b>", "paid_amount": total_card})

    return columns, data

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


------------------------------------------------------------
File: daily_payment_collection.js
------------------------------------------------------------
frappe.query_reports["Daily Payment Collection"] = {
    "filters": [
        {
            "fieldname": "from_date",
            "label": __("From Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        },
        {
            "fieldname": "to_date",
            "label": __("To Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        }
    ]
};

================================================================================
Folder: hospitality_core/report/daily_payment_collection/__pycache__
================================================================================

------------------------------------------------------------
File: daily_payment_collection.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/daily_arrivals
================================================================================

------------------------------------------------------------
File: daily_arrivals.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-28 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-28 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Daily Arrivals",
 "owner": "Administrator",
 "ref_doctype": "Hotel Reservation",
 "report_name": "Daily Arrivals",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: daily_arrivals.js
------------------------------------------------------------
frappe.query_reports["Daily Arrivals"] = {
    "filters": [
        {
            "fieldname": "date",
            "label": __("Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        }
    ]
};

------------------------------------------------------------
File: daily_arrivals.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import nowdate

def execute(filters=None):
    if not filters:
        filters = {}
        
    columns = [
        {"label": _("Reservation"), "fieldname": "name", "fieldtype": "Link", "options": "Hotel Reservation", "width": 140},
        {"label": _("Guest Name"), "fieldname": "guest_name", "fieldtype": "Data", "width": 160},
        {"label": _("Status"), "fieldname": "status", "fieldtype": "Data", "width": 100},
        {"label": _("Arrival Time"), "fieldname": "arrival_time", "fieldtype": "Time", "width": 100},
        {"label": _("Room"), "fieldname": "room", "fieldtype": "Link", "options": "Hotel Room", "width": 100},
        {"label": _("Room Type"), "fieldname": "room_type", "fieldtype": "Link", "options": "Hotel Room Type", "width": 120},
        {"label": _("Company"), "fieldname": "company", "fieldtype": "Link", "options": "Customer", "width": 140},
        {"label": _("Booked By"), "fieldname": "owner", "fieldtype": "Data", "width": 120}
    ]

    target_date = filters.get("date") or nowdate()

    # Definition: "customers that were checkedin for a specific day"
    # This implies ACTUAL arrivals.
    # We exclude 'Reserved' because they haven't checked in yet.
    # We include 'Checked Out' because if they arrived today and left today, they were still an arrival.
    
    sql = """
        SELECT
            res.name,
            guest.full_name as guest_name,
            res.status,
            TIME(res.creation) as arrival_time, 
            res.room,
            res.room_type,
            res.company,
            res.owner
        FROM
            `tabHotel Reservation` res
        LEFT JOIN
            `tabGuest` guest ON res.guest = guest.name
        WHERE
            res.arrival_date = %(target_date)s
            AND res.status IN ('Checked In', 'Checked Out')
        ORDER BY
            res.creation ASC
    """
    
    # Note: Using TIME(res.creation) as a proxy for Check-in time if no specific check-in timestamp field exists.
    # Ideally, you might want a 'check_in_time' custom field set on transition.
    
    data = frappe.db.sql(sql, {"target_date": target_date}, as_dict=True)
    return columns, data

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/daily_arrivals/__pycache__
================================================================================

------------------------------------------------------------
File: daily_arrivals.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/room_availability_report
================================================================================

------------------------------------------------------------
File: room_availability_report.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import add_days, getdate, date_diff, flt

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("Date"), "fieldname": "date", "fieldtype": "Date", "width": 110},
        {"label": _("Room Type"), "fieldname": "room_type", "fieldtype": "Link", "options": "Hotel Room Type", "width": 150},
        {"label": _("Total Rooms"), "fieldname": "total_rooms", "fieldtype": "Int", "width": 100},
        {"label": _("Out of Order"), "fieldname": "ooo", "fieldtype": "Int", "width": 100},
        {"label": _("Occupied/Sold"), "fieldname": "sold", "fieldtype": "Int", "width": 110, "description": "Confirmed + Checked In"},
        {"label": _("Available"), "fieldname": "available", "fieldtype": "Int", "width": 100},
        {"label": _("Occupancy %"), "fieldname": "occupancy_pct", "fieldtype": "Percent", "width": 100}
    ]

    data = []
    
    start_date = getdate(filters.get("from_date"))
    end_date = getdate(filters.get("to_date"))
    filter_type = filters.get("room_type")

    # 1. Get Inventory
    room_types_filters = {}
    if filter_type:
        room_types_filters["room_type_name"] = filter_type

    # Get counts of enabled rooms per type
    inventory = frappe.db.sql("""
        SELECT room_type, COUNT(name) as cnt 
        FROM `tabHotel Room` 
        WHERE is_enabled = 1 
        GROUP BY room_type
    """, as_dict=True)
    
    inventory_map = {i.room_type: i.cnt for i in inventory}
    
    all_types = list(inventory_map.keys())
    if filter_type and filter_type in all_types:
        all_types = [filter_type]

    # 2. Iterate Dates
    curr_date = start_date
    while curr_date <= end_date:
        str_date = curr_date.strftime("%Y-%m-%d")
        
        # Get OOO Rooms for this specific date (Assuming OOO status is live, not historical in this simplified model)
        # Note: A proper maintenance module would have OOO logs with dates. 
        # Here we check current OOO status for "Today", but for future dates this might be inaccurate unless we have OOO Schedule.
        # For simplicity, we assume current OOO status applies to the forecast range unless expanded.
        ooo_data = frappe.db.sql("""
            SELECT room_type, COUNT(name) as cnt 
            FROM `tabHotel Room` 
            WHERE status = 'Out of Order'
            GROUP BY room_type
        """, as_dict=True)
        ooo_map = {o.room_type: o.cnt for o in ooo_data}

        # Get Sold Rooms (Reservations covering this date)
        # Arrival <= Date AND Departure > Date
        sold_sql = """
            SELECT room_type, COUNT(name) as cnt
            FROM `tabHotel Reservation`
            WHERE status IN ('Reserved', 'Checked In')
            AND arrival_date <= %s AND departure_date > %s
            GROUP BY room_type
        """
        sold_data = frappe.db.sql(sold_sql, (str_date, str_date), as_dict=True)
        sold_map = {s.room_type: s.cnt for s in sold_data}

        for rt in all_types:
            total = inventory_map.get(rt, 0)
            ooo = ooo_map.get(rt, 0)
            sold = sold_map.get(rt, 0)
            
            # Net Availability
            avail = total - ooo - sold
            if avail < 0: avail = 0
            
            occ_pct = 0.0
            net_inventory = total - ooo
            if net_inventory > 0:
                occ_pct = (sold / net_inventory) * 100.0

            data.append({
                "date": str_date,
                "room_type": rt,
                "total_rooms": total,
                "ooo": ooo,
                "sold": sold,
                "available": avail,
                "occupancy_pct": flt(occ_pct, 1)
            })

        curr_date = add_days(curr_date, 1)

    return columns, data

------------------------------------------------------------
File: room_availability_report.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-29 11:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-29 11:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Room Availability Report",
 "owner": "Administrator",
 "ref_doctype": "Hotel Room",
 "report_name": "Room Availability Report",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "Hospitality Manager"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: room_availability_report.js
------------------------------------------------------------
frappe.query_reports["Room Availability Report"] = {
    "filters": [
        {
            "fieldname": "from_date",
            "label": __("From Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        },
        {
            "fieldname": "to_date",
            "label": __("To Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.add_days(frappe.datetime.now_date(), 14),
            "reqd": 1
        },
        {
            "fieldname": "room_type",
            "label": __("Room Type"),
            "fieldtype": "Link",
            "options": "Hotel Room Type"
        }
    ],
    "formatter": function(value, row, column, data, default_formatter) {
        value = default_formatter(value, row, column, data);
        if (column.fieldname === "available") {
            if (data.available <= 0) {
                value = `<span style="color:red; font-weight:bold;">${value}</span>`;
            } else if (data.available < 5) {
                value = `<span style="color:orange; font-weight:bold;">${value}</span>`;
            } else {
                value = `<span style="color:green; font-weight:bold;">${value}</span>`;
            }
        }
        return value;
    }
};

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/room_availability_report/__pycache__
================================================================================

------------------------------------------------------------
File: room_availability_report.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/daily_departures
================================================================================

------------------------------------------------------------
File: daily_departures.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import nowdate

def execute(filters=None):
    if not filters:
        filters = {}
    
    target_date = filters.get("date") or nowdate()

    columns = [
        {"label": _("Room"), "fieldname": "room", "fieldtype": "Link", "options": "Hotel Room", "width": 80},
        {"label": _("Guest Name"), "fieldname": "guest_name", "fieldtype": "Data", "width": 150},
        {"label": _("Reservation"), "fieldname": "name", "fieldtype": "Link", "options": "Hotel Reservation", "width": 140},
        {"label": _("Checkout Time"), "fieldname": "checkout_time", "fieldtype": "Time", "width": 100},
        {"label": _("Folio"), "fieldname": "folio", "fieldtype": "Link", "options": "Guest Folio", "width": 140},
        {"label": _("Billed To"), "fieldname": "bill_to", "fieldtype": "Data", "width": 140},
        {"label": _("Total Bill"), "fieldname": "total_charges", "fieldtype": "Currency", "width": 120},
        {"label": _("Receipts"), "fieldname": "total_payments", "fieldtype": "Currency", "width": 120}
    ]

    # Definition: "list of people that checked out per day"
    # Logic: Status is 'Checked Out' AND Departure Date is Target Date.
    
    sql = """
        SELECT
            res.room,
            guest.full_name as guest_name,
            res.name,
            TIME(res.modified) as checkout_time,
            res.folio,
            COALESCE(res.company, 'Guest') as bill_to,
            folio.total_charges,
            folio.total_payments
        FROM
            `tabHotel Reservation` res
        LEFT JOIN
            `tabGuest` guest ON res.guest = guest.name
        LEFT JOIN
            `tabGuest Folio` folio ON res.folio = folio.name
        WHERE
            res.departure_date = %(target_date)s
            AND res.status = 'Checked Out'
        ORDER BY
            res.modified ASC
    """
    
    # Note: We use TIME(res.modified) as proxy for checkout time because 
    # the Reservation is submitted/modified upon checkout. 
    
    data = frappe.db.sql(sql, {"target_date": target_date}, as_dict=True)
    return columns, data

------------------------------------------------------------
File: daily_departures.js
------------------------------------------------------------
frappe.query_reports["Daily Departures"] = {
    "filters": [
        {
            "fieldname": "date",
            "label": __("Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        }
    ],
    "formatter": function(value, row, column, data, default_formatter) {
        value = default_formatter(value, row, column, data);
        
        if (column.fieldname == "checkout_status") {
            if (data.checkout_status == "Overstay") {
                value = `<span style="color:red; font-weight:bold;">${value}</span>`;
            } else if (data.checkout_status == "Completed") {
                value = `<span style="color:green;">${value}</span>`;
            }
        }
        return value;
    }
};

------------------------------------------------------------
File: daily_departures.json
------------------------------------------------------------
{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-01-28 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-28 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Daily Departures",
 "owner": "Administrator",
 "ref_doctype": "Hotel Reservation",
 "report_name": "Daily Departures",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "Hospitality Manager"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/daily_departures/__pycache__
================================================================================

------------------------------------------------------------
File: daily_departures.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/report/daily_sales_consumption
================================================================================

------------------------------------------------------------
File: daily_sales_consumption.js
------------------------------------------------------------
frappe.query_reports["Daily Sales Consumption"] = {
    "filters": [
        {
            "fieldname": "from_date",
            "label": __("From Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        },
        {
            "fieldname": "to_date",
            "label": __("To Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.now_date(),
            "reqd": 1
        }
    ]
};

------------------------------------------------------------
File: daily_sales_consumption.py
------------------------------------------------------------
import frappe
from frappe import _

def execute(filters=None):
    if not filters:
        filters = {}

    columns = [
        {"label": _("Date"), "fieldname": "posting_date", "fieldtype": "Date", "width": 100},
        {"label": _("Room"), "fieldname": "room", "fieldtype": "Data", "width": 80},
        {"label": _("Guest"), "fieldname": "guest_name", "fieldtype": "Data", "width": 150},
        {"label": _("Department / Item Group"), "fieldname": "item_group", "fieldtype": "Data", "width": 150},
        {"label": _("Description"), "fieldname": "description", "fieldtype": "Data", "width": 200},
        {"label": _("Amount"), "fieldname": "amount", "fieldtype": "Currency", "width": 120}
    ]

    # Filters
    date_from = filters.get("from_date")
    date_to = filters.get("to_date")

    # SQL Logic:
    # 1. We query `Folio Transaction`
    # 2. We join `Item` to get the Item Group (Department)
    # 3. We exclude Voided transactions and Payments (Amount < 0)
    #    *Payments are Cash Flow, not Sales Revenue.
    
    sql = """
        SELECT
            ft.posting_date,
            gf.room,
            guest.full_name as guest_name,
            item.item_group,
            ft.description,
            ft.amount
        FROM
            `tabFolio Transaction` ft
        INNER JOIN
            `tabGuest Folio` gf ON ft.parent = gf.name
        LEFT JOIN
            `tabGuest` guest ON gf.guest = guest.name
        LEFT JOIN
            `tabItem` item ON ft.item = item.name
        WHERE
            ft.posting_date BETWEEN %(from_date)s AND %(to_date)s
            AND ft.is_void = 0
            AND ft.amount > 0 
        ORDER BY
            ft.posting_date, item.item_group
    """
    
    data = frappe.db.sql(sql, {"from_date": date_from, "to_date": date_to}, as_dict=True)
    
    # Add Summary Row
    total_sales = sum([d.amount for d in data])
    if data:
        data.append({
            "posting_date": "",
            "room": "",
            "guest_name": "<b>TOTAL</b>",
            "item_group": "",
            "description": "",
            "amount": total_sales
        })

    return columns, data

------------------------------------------------------------
File: daily_sales_consumption.json
------------------------------------------------------------
{
 "add_total_row": 1,
 "columns": [],
 "creation": "2025-01-28 12:00:00.000000",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "modified": "2025-01-28 12:00:00.000000",
 "modified_by": "Administrator",
 "module": "Hospitality Core",
 "name": "Daily Sales Consumption",
 "owner": "Administrator",
 "ref_doctype": "Guest Folio",
 "report_name": "Daily Sales Consumption",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Hospitality User"
  },
  {
   "role": "System Manager"
  }
 ]
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/report/daily_sales_consumption/__pycache__
================================================================================

------------------------------------------------------------
File: daily_sales_consumption.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: hospitality_core/print_format
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/print_format/guest_folio_classic
================================================================================

------------------------------------------------------------
File: guest_folio_classic.html
------------------------------------------------------------
<div class="print-format-gutter">
    <div class="row">
        <div class="col-xs-12 text-center">
            <h3>{{ frappe.db.get_value("Company", doc.company or frappe.defaults.get_user_default("Company"), "company_name") }}</h3>
            <p>{{ frappe.db.get_value("Company", doc.company or frappe.defaults.get_user_default("Company"), "tax_id") or "" }}</p>
            <h4>GUEST FOLIO</h4>
        </div>
    </div>
    
    <hr>

    <div class="row" style="margin-bottom: 20px;">
        <div class="col-xs-6">
            <strong>Guest Name:</strong> {{ frappe.db.get_value("Guest", doc.guest, "full_name") }}<br>
            <strong>Address:</strong> {{ frappe.db.get_value("Guest", doc.guest, "address") or "-" }}<br>
            <strong>Company:</strong> {{ doc.company or "-" }}
        </div>
        <div class="col-xs-6 text-right">
            <strong>Folio No:</strong> {{ doc.name }}<br>
            <strong>Room No:</strong> {{ doc.room }}<br>
            <strong>Date:</strong> {{ frappe.utils.now_date() }}
        </div>
    </div>

    <table class="table table-bordered table-condensed">
        <thead>
            <tr>
                <th style="width: 15%">Date</th>
                <th style="width: 50%">Description</th>
                <th style="width: 10%">Qty</th>
                <th style="width: 25%; text-align: right;">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for row in doc.transactions %}
            {% if not row.is_void %}
            <tr>
                <td>{{ frappe.utils.formatdate(row.posting_date) }}</td>
                <td>{{ row.description }}</td>
                <td>{{ row.qty }}</td>
                <td style="text-align: right;">{{ row.get_formatted("amount", doc) }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th colspan="3" class="text-right">Total Charges</th>
                <th class="text-right">{{ doc.get_formatted("total_charges") }}</th>
            </tr>
            <tr>
                <th colspan="3" class="text-right">Total Payments</th>
                <th class="text-right">{{ doc.get_formatted("total_payments") }}</th>
            </tr>
            <tr>
                <th colspan="3" class="text-right">Balance Due</th>
                <th class="text-right" style="font-size: 1.2em;">{{ doc.get_formatted("outstanding_balance") }}</th>
            </tr>
        </tfoot>
    </table>

    <div class="row" style="margin-top: 50px;">
        <div class="col-xs-6">
            <br><br>
            __________________________<br>
            Guest Signature
        </div>
        <div class="col-xs-6 text-right">
            <br><br>
            __________________________<br>
            Cashier
        </div>
    </div>
</div>

------------------------------------------------------------
File: guest_folio_classic.json
------------------------------------------------------------
{
 "align_labels_right": 0,
 "creation": "2025-01-28 14:00:00.000000",
 "custom_format": 1,
 "doc_type": "Guest Folio",
 "docstatus": 0,
 "doctype": "Print Format",
 "html": "<!-- Logic Handled in Jinja File -->",
 "line_breaks": 0,
 "module": "Hospitality Core",
 "name": "Guest Folio Classic",
 "owner": "Administrator",
 "print_format_type": "Jinja",
 "raw_printing": 0,
 "show_section_headings": 0,
 "standard": "Yes"
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/workspace
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/workspace/hospitality
================================================================================

------------------------------------------------------------
File: hospitality.json
------------------------------------------------------------
{
 "charts": [],
 "content": "[{\"id\":\"KetbGV2NUv\",\"type\":\"header\",\"data\":{\"text\":\"<span class=\\\"h4\\\">Front Desk Operations</span>\",\"col\":12}},{\"id\":\"AFikpVG8G_\",\"type\":\"shortcut\",\"data\":{\"shortcut_name\":\"Front Desk Console\",\"col\":4}},{\"id\":\"LmjeZv2AcL\",\"type\":\"shortcut\",\"data\":{\"shortcut_name\":\"Tape Chart\",\"col\":4}},{\"id\":\"is7sVl6bVG\",\"type\":\"shortcut\",\"data\":{\"shortcut_name\":\"Availability Query\",\"col\":4}},{\"id\":\"KRRJXdLa5m\",\"type\":\"shortcut\",\"data\":{\"shortcut_name\":\"Guest 360 View\",\"col\":4}},{\"id\":\"Vqn38JTnz-\",\"type\":\"shortcut\",\"data\":{\"shortcut_name\":\"Maintenance Requests\",\"col\":4}},{\"id\":\"41rbMghVLH\",\"type\":\"shortcut\",\"data\":{\"shortcut_name\":\"Housekeeping Board\",\"col\":4}},{\"id\":\"qypRwgKZsT\",\"type\":\"header\",\"data\":{\"text\":\"<span class=\\\"h4\\\">Management &amp; Inventory</span>\",\"col\":12}},{\"id\":\"3fpFN3V6Ax\",\"type\":\"card\",\"data\":{\"card_name\":\"Operations\",\"col\":4}},{\"id\":\"QcU-MEY5VS\",\"type\":\"card\",\"data\":{\"card_name\":\"Inventory & Rates\",\"col\":4}},{\"id\":\"n54kJReGGr\",\"type\":\"card\",\"data\":{\"card_name\":\"Accounting & Billing\",\"col\":4}},{\"id\":\"DiTXVcW0Fx\",\"type\":\"header\",\"data\":{\"text\":\"<span class=\\\"h4\\\">Operational Reports</span>\",\"col\":12}},{\"id\":\"QQwoEW_WYs\",\"type\":\"card\",\"data\":{\"card_name\":\"Operational Reports\",\"col\":4}},{\"id\":\"ye4-MwIyfp\",\"type\":\"card\",\"data\":{\"card_name\":\"Maintenance & Logs\",\"col\":4}},{\"id\":\"vHLVgSFGJ7\",\"type\":\"header\",\"data\":{\"text\":\"<span class=\\\"h4\\\">Financial Reports &amp; Analytics</span>\",\"col\":12}},{\"id\":\"eiDfp-ImIL\",\"type\":\"card\",\"data\":{\"card_name\":\"Financial Reports\",\"col\":4}},{\"id\":\"1XswkkRf_g\",\"type\":\"card\",\"data\":{\"card_name\":\"Analytics\",\"col\":4}}]",
 "creation": "2025-01-28 13:00:00",
 "custom_blocks": [],
 "docstatus": 0,
 "doctype": "Workspace",
 "for_user": "",
 "hide_custom": 0,
 "icon": "hotel",
 "idx": 0,
 "is_hidden": 0,
 "label": "Hospitality",
 "links": [
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Operations",
   "link_count": 0,
   "onboard": 0,
   "type": "Card Break"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Hotel Reservation",
   "link_count": 0,
   "link_to": "Hotel Reservation",
   "link_type": "DocType",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Guest",
   "link_count": 0,
   "link_to": "Guest",
   "link_type": "DocType",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Hotel Group Booking",
   "link_count": 0,
   "link_to": "Hotel Group Booking",
   "link_type": "DocType",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Inventory & Rates",
   "link_count": 0,
   "onboard": 0,
   "type": "Card Break"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Hotel Room",
   "link_count": 0,
   "link_to": "Hotel Room",
   "link_type": "DocType",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Hotel Room Type",
   "link_count": 0,
   "link_to": "Hotel Room Type",
   "link_type": "DocType",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Room Rate Plan",
   "link_count": 0,
   "link_to": "Room Rate Plan",
   "link_type": "DocType",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Accounting & Billing",
   "link_count": 0,
   "onboard": 0,
   "type": "Card Break"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Guest Folio",
   "link_count": 0,
   "link_to": "Guest Folio",
   "link_type": "DocType",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Allowance Reason Code",
   "link_count": 0,
   "link_to": "Allowance Reason Code",
   "link_type": "DocType",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Operational Reports",
   "link_count": 0,
   "onboard": 0,
   "type": "Card Break"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "House List",
   "link_count": 0,
   "link_to": "House List",
   "link_type": "Report",
   "onboard": 0,
   "report_ref_doctype": "Hotel Reservation",
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Daily Arrivals",
   "link_count": 0,
   "link_to": "Daily Arrivals",
   "link_type": "Report",
   "onboard": 0,
   "report_ref_doctype": "Hotel Reservation",
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Daily Departures",
   "link_count": 0,
   "link_to": "Daily Departures",
   "link_type": "Report",
   "onboard": 0,
   "report_ref_doctype": "Hotel Reservation",
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Room Availability Report",
   "link_count": 0,
   "link_to": "Room Availability Report",
   "link_type": "Report",
   "onboard": 0,
   "report_ref_doctype": "Hotel Room",
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Maintenance & Logs",
   "link_count": 0,
   "onboard": 0,
   "type": "Card Break"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Maintenance Log Report",
   "link_count": 0,
   "link_to": "Maintenance Log Report",
   "link_type": "Report",
   "onboard": 0,
   "report_ref_doctype": "Hotel Maintenance Request",
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Analytics",
   "link_count": 0,
   "onboard": 0,
   "type": "Card Break"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Hotel Performance Analytics",
   "link_count": 0,
   "link_to": "Hotel Performance Analytics",
   "link_type": "Report",
   "onboard": 0,
   "report_ref_doctype": "Hotel Reservation",
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 0,
   "label": "Financial Reports",
   "link_count": 7,
   "link_type": "DocType",
   "onboard": 0,
   "type": "Card Break"
  },
  {
   "hidden": 0,
   "is_query_report": 1,
   "label": "Daily Sales Consumption",
   "link_count": 0,
   "link_to": "Daily Sales Consumption",
   "link_type": "Report",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 1,
   "label": "Daily Payment Collection",
   "link_count": 0,
   "link_to": "Daily Payment Collection",
   "link_type": "Report",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 1,
   "label": "Guest Ledger",
   "link_count": 0,
   "link_to": "Guest Ledger",
   "link_type": "Report",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 1,
   "label": "City Ledger",
   "link_count": 0,
   "link_to": "City Ledger",
   "link_type": "Report",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 1,
   "label": "Folio Balance Summary",
   "link_count": 0,
   "link_to": "Folio Balance Summary",
   "link_type": "Report",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 1,
   "label": "Void and Allowance Report",
   "link_count": 0,
   "link_to": "Void and Allowance Report",
   "link_type": "Report",
   "onboard": 0,
   "type": "Link"
  },
  {
   "hidden": 0,
   "is_query_report": 1,
   "label": "Discount and Complimentary Report",
   "link_count": 0,
   "link_to": "Discount and Complimentary Report",
   "link_type": "Report",
   "onboard": 0,
   "type": "Link"
  }
 ],
 "modified": "2025-12-20 02:04:06.031477",
 "modified_by": "braimahgifted@gmail.com",
 "module": "Hospitality Core",
 "name": "Hospitality",
 "number_cards": [],
 "owner": "Administrator",
 "public": 1,
 "quick_lists": [],
 "roles": [
  {
   "role": "System Manager"
  },
  {
   "role": "Hospitality User"
  },
  {
   "role": "Hospitality Manager"
  }
 ],
 "sequence_id": 1.0,
 "shortcuts": [
  {
   "label": "Front Desk Console",
   "link_to": "front-desk-console",
   "type": "Page"
  },
  {
   "label": "Tape Chart",
   "link_to": "tape-chart",
   "type": "Page"
  },
  {
   "label": "Availability Query",
   "link_to": "availability-tool",
   "type": "Page"
  },
  {
   "label": "Guest 360 View",
   "link_to": "guest-360",
   "type": "Page"
  },
  {
   "label": "Housekeeping Board",
   "link_to": "housekeeping-view",
   "type": "Page"
  },
  {
   "label": "Maintenance Requests",
   "link_to": "Hotel Maintenance Request",
   "type": "DocType"
  }
 ],
 "title": "Hospitality"
}

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: hospitality_core/api
================================================================================

------------------------------------------------------------
File: stock.py
------------------------------------------------------------
import frappe
from frappe import _

def deduct_inventory(doc, method=None):
    """
    Hook: Guest Folio (on_update) or Folio Transaction (after_insert).
    Logic: If a new transaction is added for a Stock Item, create a Stock Entry (Material Issue).
    """
    
    if doc.doctype != "Folio Transaction":
        return

    if doc.is_void or doc.amount <= 0:
        return

    # 1. Check if Item is a Stock Item
    item_details = frappe.db.get_value("Item", doc.item, ["is_stock_item", "default_warehouse"], as_dict=True)
    if not item_details or not item_details.is_stock_item:
        return

    # 2. Get Room Warehouse
    folio = frappe.get_doc("Guest Folio", doc.parent)
    room_warehouse = frappe.db.get_value("Hotel Room", folio.room, "warehouse")
    
    # Use Company from Folio if available, otherwise User Default
    # Note: Guest Folio doesn't strictly have a 'Company' field for the Hotel Entity, 
    # it has 'company' linking to Customer. 
    # We should rely on System Defaults or the User's Company for the Hotel's side.
    hotel_company = frappe.defaults.get_user_default("Company")
    
    if not room_warehouse:
        # Fallback to Item default or System default
        room_warehouse = item_details.default_warehouse or frappe.db.get_value("Stock Settings", None, "default_warehouse")
        
    if not room_warehouse:
        frappe.log_error(f"Skipping Stock Deduction for {doc.item}. No Warehouse found for Room {folio.room}", "Hotel Stock Error")
        return
        
    # Validate Warehouse belongs to Company
    wh_company = frappe.db.get_value("Warehouse", room_warehouse, "company")
    if wh_company != hotel_company:
        frappe.log_error(f"Warehouse {room_warehouse} belongs to {wh_company}, expected {hotel_company}", "Hotel Stock Error")
        return

    # 3. Create Stock Entry (Material Issue)
    se = frappe.new_doc("Stock Entry")
    se.stock_entry_type = "Material Issue"
    se.purpose = "Material Issue"
    se.posting_date = doc.posting_date
    se.company = hotel_company
    
    # Add Item
    se.append("items", {
        "item_code": doc.item,
        "qty": doc.qty,
        "uom": frappe.db.get_value("Item", doc.item, "stock_uom"),
        "s_warehouse": room_warehouse,
        "cost_center": frappe.get_cached_value('Company', se.company, 'cost_center')
    })
    
    try:
        se.insert(ignore_permissions=True)
        se.submit()
        frappe.msgprint(_("Consumed {0} from Warehouse {1}").format(doc.item, room_warehouse), alert=True)
        
        # Link Stock Entry to Transaction for reference
        frappe.db.set_value("Folio Transaction", doc.name, {
            "reference_doctype": "Stock Entry",
            "reference_name": se.name
        })
        
    except Exception as e:
        frappe.log_error(f"Failed to deduct stock for {doc.item}: {str(e)}", "Hotel Stock Error")

------------------------------------------------------------
File: folio.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import flt

def sync_folio_balance(doc, method=None):
    """
    Recalculates Total Charges, Total Payments, and Outstanding Balance.
    Triggered on: Guest Folio (on_update), Folio Transaction (after_save/on_trash).
    """
    # If called from Child Table event, doc is the child
    if doc.doctype == "Folio Transaction":
        folio_name = doc.parent
        # Trigger Mirroring only on new/updated transactions
        # We skip mirroring for transfer items to avoid zeroing out the Master Folio at checkout
        if not doc.is_void and doc.item not in ["TRANSFER", "TRANSFER-GROUP"]:
            if doc.bill_to == "Company":
                mirror_to_company_folio(doc)
            elif doc.bill_to == "Group":
                mirror_to_group_folio(doc)
    else:
        folio_name = doc.name

    # Aggregation Query
    # We filter out void transactions
    totals = frappe.db.sql("""
        SELECT 
            SUM(CASE WHEN amount > 0 THEN amount ELSE 0 END) as charges,
            SUM(CASE WHEN amount < 0 THEN ABS(amount) ELSE 0 END) as payments
        FROM `tabFolio Transaction`
        WHERE parent = %s AND is_void = 0
    """, (folio_name,), as_dict=True)[0]

    total_charges = totals.charges or 0.0
    total_payments = totals.payments or 0.0
    outstanding = total_charges - total_payments

    # Direct DB update
    frappe.db.set_value("Guest Folio", folio_name, {
        "total_charges": total_charges,
        "total_payments": total_payments,
        "outstanding_balance": outstanding
    })
    
    # Check Credit Limit if linked to Company
    folio_company = frappe.db.get_value("Guest Folio", folio_name, "company")
    if folio_company and outstanding > 0:
        check_credit_limit(folio_company, outstanding)

def check_credit_limit(customer_id, current_exposure):
    """
    Checks if the Customer has exceeded their Credit Limit including current exposure.
    """
    try:
        hotel_company = frappe.defaults.get_user_default("Company")
        if not hotel_company:
            hotel_company = frappe.db.get_single_value("Global Defaults", "default_company")
        
        if not hotel_company:
            return

        credit_limit = 0.0
        
        # 1. Try Child Table (v15+)
        if frappe.db.get_value("DocType", "Customer Credit Limit", "name"):
            credit_limit = frappe.db.get_value("Customer Credit Limit", 
                {"parent": customer_id, "company": hotel_company}, 
                "credit_limit"
            )
        
        # 2. Fallback to main field
        if not credit_limit:
             credit_limit = frappe.db.get_value("Customer", customer_id, "credit_limit")

        if not credit_limit or flt(credit_limit) <= 0:
            return

        # Get current ERP Balance for Customer
        erp_balance = 0.0
        try:
            from erpnext.accounts.utils import get_balance_on
            erp_balance = get_balance_on(party_type="Customer", party=customer_id)
        except ImportError:
            erp_balance = frappe.db.get_value("Customer", customer_id, "total_unpaid") or 0.0
        except Exception:
            pass

        total_liability = flt(erp_balance) + flt(current_exposure)
        
        if total_liability > flt(credit_limit):
            frappe.msgprint(_("Warning: Credit Limit Exceeded for {0}. Limit: {1}, Liability: {2}").format(
                customer_id, 
                frappe.format(credit_limit, "Currency"), 
                frappe.format(total_liability, "Currency")
            ), alert=True)

    except Exception as e:
        frappe.log_error(f"Credit Limit Check Failed for {customer_id}: {str(e)}", "Hospitality Core")

def mirror_to_company_folio(transaction_doc):
    """
    If a transaction is Bill To Company, we post a copy to the Company's Master Folio.
    Updates: Ensures description contains Guest/Reservation info.
    """
    # 1. Identify the Company
    guest_folio = frappe.get_doc("Guest Folio", transaction_doc.parent)
    company = guest_folio.company
    
    if not company:
        return

    # 2. Find Master Folio for Company
    master_folio = frappe.db.get_value("Guest Folio", {
        "company": company, 
        "status": "Open",
        "is_company_master": 1,
        "name": ["!=", guest_folio.name]
    }, "name")

    # If no master exists, we skip. It usually should be created at Reservation Check-in.
    if not master_folio:
        return

    # 3. Check if already mirrored
    exists = frappe.db.exists("Folio Transaction", {
        "parent": master_folio,
        "reference_name": transaction_doc.name,
        "reference_doctype": "Folio Transaction"
    })
    
    if exists:
        return

    # 4. Create Mirror Transaction
    # Enhanced Description for clarity on Master Bill: "Original Desc [Res: ID (Guest Name)]"
    ref_info = ""
    if guest_folio.reservation:
        ref_info = f"Res: {guest_folio.reservation}"
        # Fetch guest name if not evident
        guest_name = frappe.db.get_value("Hotel Reservation", guest_folio.reservation, "guest")
        if guest_name:
            guest_full_name = frappe.db.get_value("Guest", guest_name, "full_name")
            ref_info += f" ({guest_full_name})"
    else:
        ref_info = f"Room: {guest_folio.room}"
    
    new_txn = frappe.get_doc({
        "doctype": "Folio Transaction",
        "parent": master_folio,
        "parenttype": "Guest Folio",
        "parentfield": "transactions",
        "posting_date": transaction_doc.posting_date,
        "item": transaction_doc.item,
        "description": f"{transaction_doc.description} [{ref_info}]",
        "qty": transaction_doc.qty,
        "amount": transaction_doc.amount,
        "bill_to": "Company",
        "reference_doctype": "Folio Transaction",
        "reference_name": transaction_doc.name,
        "is_void": 0
    })
    new_txn.insert(ignore_permissions=True)
    
    # Sync Company Folio Balance
    sync_folio_balance(frappe.get_doc("Guest Folio", master_folio))

def mirror_to_group_folio(transaction_doc):
    """
    If a transaction is Bill To Group, we post a copy to the Group's Master Folio.
    """
    # 1. Identify the Group
    guest_folio = frappe.get_doc("Guest Folio", transaction_doc.parent)
    reservation = guest_folio.reservation
    
    if not reservation:
        return

    group_booking = frappe.db.get_value("Hotel Reservation", reservation, "group_booking")
    if not group_booking:
        return

    # 2. Find Master Folio for Group
    master_folio = frappe.db.get_value("Hotel Group Booking", group_booking, "master_folio")

    # If no master exists, we skip.
    if not master_folio or master_folio == guest_folio.name:
        return

    # 3. Check if already mirrored
    exists = frappe.db.exists("Folio Transaction", {
        "parent": master_folio,
        "reference_name": transaction_doc.name,
        "reference_doctype": "Folio Transaction"
    })
    
    if exists:
        return

    # 4. Create Mirror Transaction
    guest_name = frappe.db.get_value("Hotel Reservation", reservation, "guest")
    guest_full_name = frappe.db.get_value("Guest", guest_name, "full_name") if guest_name else "Unknown"
    
    ref_info = f"Res: {reservation} ({guest_full_name}) | Room: {guest_folio.room}"
    
    new_txn = frappe.get_doc({
        "doctype": "Folio Transaction",
        "parent": master_folio,
        "parenttype": "Guest Folio",
        "parentfield": "transactions",
        "posting_date": transaction_doc.posting_date,
        "item": transaction_doc.item,
        "description": f"{transaction_doc.description} [{ref_info}]",
        "qty": transaction_doc.qty,
        "amount": transaction_doc.amount,
        "bill_to": "Group",
        "reference_doctype": "Folio Transaction",
        "reference_name": transaction_doc.name,
        "is_void": 0
    })
    new_txn.insert(ignore_permissions=True)
    
    # Sync Group Folio Balance
    sync_folio_balance(frappe.get_doc("Guest Folio", master_folio))

@frappe.whitelist()
def move_transactions(transaction_names, target_folio):
    """
    Moves selected transactions from Source Folio to Target Folio.
    """
    if isinstance(transaction_names, str):
        import json
        transaction_names = json.loads(transaction_names)

    if not transaction_names:
        frappe.throw(_("No transactions selected"))

    target_doc = frappe.get_doc("Guest Folio", target_folio)
    if target_doc.status != "Open":
        frappe.throw(_("Target Folio must be Open"))

    source_folio_name = None

    for txn_name in transaction_names:
        txn = frappe.get_doc("Folio Transaction", txn_name)
        
        if txn.is_invoiced:
            frappe.throw(_("Cannot move invoiced transaction: {0}").format(txn.description))
            
        source_folio_name = txn.parent
        
        # Move: Update Parent
        frappe.db.set_value("Folio Transaction", txn.name, "parent", target_folio)
        
        # Audit Trail
        txn.add_comment("Info", _("Moved from Folio {0} to {1}").format(source_folio_name, target_folio))

    # Sync Balances for both
    if source_folio_name:
        sync_folio_balance(frappe.get_doc("Guest Folio", source_folio_name))
    
    sync_folio_balance(target_doc)
    
    return True

------------------------------------------------------------
File: invoicing.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import flt

@frappe.whitelist()
def create_invoice_from_folio(folio_name):
    """
    Generates a Sales Invoice for all unbilled transactions in the Folio.
    """
    folio = frappe.get_doc("Guest Folio", folio_name)
    
    # Determine Customer
    # If Folio has a specific Company linked, use that. Otherwise, check Guest -> Customer link.
    customer = folio.company
    if not customer:
        guest_doc = frappe.get_doc("Guest", folio.guest)
        if guest_doc.customer:
            customer = guest_doc.customer
        else:
            frappe.throw(_("Please link a Customer (Company) to this Folio or the Guest Profile to generate an Invoice."))

    # Identify Unbilled Transactions
    items_to_bill = []
    transaction_ids = []
    
    # Use the Company defined on the Customer or default to user's company (but ideally Folio should drive this if multi-company)
    company = frappe.defaults.get_user_default("Company") or frappe.db.get_single_value("Global Defaults", "default_company")
    
    # Fetch default Cost Center for this Company
    default_cost_center = frappe.get_cached_value('Company', company, 'cost_center')

    for trans in folio.transactions:
        if not trans.is_invoiced and not trans.is_void:
            income_account = get_income_account(trans.item, company)
            
            if not income_account:
                frappe.throw(_("Could not determine Income Account for Item {0} in Company {1}. Please check Item or Item Group accounting defaults.").format(trans.item, company))

            items_to_bill.append({
                "item_code": trans.item,
                "description": trans.description,
                "qty": trans.qty,
                "rate": trans.amount / trans.qty if trans.qty else 0,
                "income_account": income_account,
                "cost_center": default_cost_center
            })
            transaction_ids.append(trans.name)
    
    if not items_to_bill:
        frappe.throw(_("No unbilled transactions found to invoice."))

    # Create Sales Invoice
    si = frappe.new_doc("Sales Invoice")
    si.customer = customer
    si.company = company
    si.posting_date = frappe.utils.nowdate()
    si.due_date = frappe.utils.nowdate()
    si.set("items", items_to_bill)
    
    # Set Taxes (Optional: Fetch from Template)
    # si.set_taxes() 

    si.save()
    
    # Link Invoice to Transactions (to prevent double billing)
    for row_name in transaction_ids:
        frappe.db.set_value("Folio Transaction", row_name, {
            "is_invoiced": 1,
            "reference_doctype": "Sales Invoice",
            "reference_name": si.name
        })
    
    return si.name

def get_income_account(item_code, company):
    """
    Resolves the Income Account for an Item in the given Company.
    Order: Item Default > Item Group Default > Company Default
    """
    account = None

    # 1. Check 'Item Default' child table
    account = frappe.db.get_value("Item Default", {"parent": item_code, "company": company}, "income_account")

    # 2. Check Item Group Default child table
    if not account:
        item_group = frappe.db.get_value("Item", item_code, "item_group")
        if item_group:
            # In v15+, defaults are in 'Item Group Default' child table
            account = frappe.db.get_value("Item Group Default", {"parent": item_group, "company": company}, "income_account")

    # 3. Fallback to Company Default
    if not account:
        account = frappe.get_cached_value('Company', company, 'default_income_account')
        
    return account

------------------------------------------------------------
File: room_move.py
------------------------------------------------------------
import frappe
from frappe import _
from hospitality_core.hospitality_core.api.reservation import check_availability

@frappe.whitelist()
def process_room_move(reservation_name, new_room):
    """
    Moves a checked-in guest to a new room.
    1. Validate New Room availability.
    2. Mark Old Room 'Dirty'.
    3. Mark New Room 'Occupied'.
    4. Update Reservation and Folio.
    """
    
    res = frappe.get_doc("Hotel Reservation", reservation_name)
    
    if res.status != "Checked In":
        frappe.throw(_("Room moves are only allowed for Checked In guests."))
        
    if res.room == new_room:
        frappe.throw(_("New Room cannot be the same as Current Room."))

    old_room = res.room

    # 1. Validate Availability (for the remaining dates)
    # We check from Today to Departure Date
    check_availability(new_room, frappe.utils.nowdate(), res.departure_date, ignore_reservation=res.name)

    # 2. Update Statuses
    # Old Room -> Dirty
    frappe.db.set_value("Hotel Room", old_room, "status", "Dirty")
    
    # New Room -> Occupied
    frappe.db.set_value("Hotel Room", new_room, "status", "Occupied")

    # 3. Update Documents
    # Update Reservation
    res.room = new_room
    res.save(ignore_permissions=True)
    
    # Update Folio
    if res.folio:
        frappe.db.set_value("Guest Folio", res.folio, "room", new_room)

    # 4. Log the Move (Optional: Add a comment)
    res.add_comment("Info", _("Moved from Room {0} to Room {1} on {2}").format(
        old_room, new_room, frappe.utils.now_datetime()
    ))
    
    frappe.msgprint(_("Successfully moved guest to Room {0}").format(new_room))
    
    return True

------------------------------------------------------------
File: financial_control.py
------------------------------------------------------------
import frappe
from frappe import _

@frappe.whitelist()
def void_transaction(folio_transaction_name, reason_code):
    """
    Marks a transaction as Void.
    """
    # 1. Fetch Transaction
    trans = frappe.get_doc("Folio Transaction", folio_transaction_name)
    
    if trans.is_invoiced:
        frappe.throw(_("Cannot void this transaction because it has already been invoiced (Sales Invoice generated). Create a Credit Note instead."))

    if trans.is_void:
        frappe.throw(_("Transaction is already void."))

    # 2. Check Permissions / Approval
    reason_doc = frappe.get_doc("Allowance Reason Code", reason_code)
    if reason_doc.requires_manager_approval:
        if "Hospitality Manager" not in frappe.get_roles():
            frappe.throw(_("This Reason Code requires Manager Approval."))

    # 3. Update Transaction
    frappe.db.set_value("Folio Transaction", trans.name, {
        "is_void": 1,
        "void_reason": reason_code,
        "amount": 0 # Zero out amount so it doesn't affect balance, OR keep amount but exclude in SQL. 
                    # Logic in 'sync_folio_balance' handles 'is_void=1' by ignoring it.
                    # Best practice: Keep the amount for audit, ignore in sum.
    })

    # 4. Trigger Recalculation
    from hospitality_core.hospitality_core.api.folio import sync_folio_balance
    sync_folio_balance(frappe.get_doc("Guest Folio", trans.parent))

    frappe.msgprint(_("Transaction Voided Successfully."))

------------------------------------------------------------
File: payment_bridge.py
------------------------------------------------------------
import frappe
from frappe import _

def process_payment_entry(doc, method=None):
    """
    Hook: Payment Entry (on_submit)
    Logic: If Reference No matches a Guest Folio ID, post a credit transaction to that Folio.
    """
    if doc.docstatus != 1:
        return
        
    # Check if linked to Folio via Reference No
    # We expect reference_no to hold the Folio ID (e.g., FOLIO-...)
    if not doc.reference_no or not frappe.db.exists("Guest Folio", doc.reference_no):
        return
        
    folio_name = doc.reference_no
    
    # Determine Amount (Paid Amount is usually positive in Payment Entry)
    # We need a negative amount to reduce the Folio Balance.
    amount = doc.paid_amount
    credit_amount = -1 * abs(amount)
    
    # Ensure Payment Item Exists
    item_code = "PAYMENT"
    if not frappe.db.exists("Item", item_code):
        item = frappe.new_doc("Item")
        item.item_code = item_code
        item.item_name = "Payment Credit"
        item.item_group = "Services" if frappe.db.exists("Item Group", "Services") else "All Item Groups"
        item.is_stock_item = 0
        item.insert(ignore_permissions=True)
    
    # Insert Transaction
    frappe.get_doc({
        "doctype": "Folio Transaction",
        "parent": folio_name,
        "parenttype": "Guest Folio",
        "parentfield": "transactions",
        "posting_date": doc.posting_date,
        "item": item_code,
        "description": f"Payment Entry: {doc.name} ({doc.mode_of_payment})",
        "qty": 1,
        "amount": credit_amount,
        "bill_to": "Guest", 
        "reference_doctype": "Payment Entry",
        "reference_name": doc.name,
        "is_invoiced": 0 # Payments are not invoices
    }).insert(ignore_permissions=True)
    
    # Sync Balance
    from hospitality_core.hospitality_core.api.folio import sync_folio_balance
    sync_folio_balance(frappe.get_doc("Guest Folio", folio_name))
    
    frappe.msgprint(_("Payment of {0} successfully recorded on Folio {1}").format(amount, folio_name))

------------------------------------------------------------
File: night_audit.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import add_days, nowdate, getdate, flt
from hospitality_core.hospitality_core.api.folio import sync_folio_balance, mirror_to_company_folio, mirror_to_group_folio

def run_daily_audit():
    """
    Scheduled Job: Runs at 2 PM daily.
    1. Checks for Overstays.
    2. Posts Room Rent + Discounts for all rooms currently Checked In.
    3. SKIPS posting if a Room Rent charge already exists for the current date.
    """
    posting_date = nowdate()
    
    # 1. Fetch active reservations with Discount settings
    active_reservations = frappe.get_all("Hotel Reservation", 
        filters={"status": "Checked In"},
        fields=[
            "name", "guest", "room", "room_type", "rate_plan", 
            "departure_date", "company", "folio",
            "is_complimentary", "discount_type", "discount_value",
            "is_company_guest", "is_group_guest", "group_booking"
        ]
    )

    count = 0
    for res in active_reservations:
        if process_single_reservation(res, posting_date):
            count += 1

    if count > 0:
        frappe.msgprint(_("Auto-Bill (2 PM): Posted charges for {0} rooms.").format(count))

def process_single_reservation(res, posting_date):
    if getdate(res.departure_date) <= getdate(posting_date):
        handle_overstay(res)

    if already_charged_today(res.folio, posting_date):
        return False

    # Get Base Rate
    daily_rate = get_rate(res.rate_plan, res.room_type, posting_date)
    
    if daily_rate > 0:
        post_room_charge(res, daily_rate, posting_date)
        return True
        
    return False

def already_charged_today(folio_name, date):
    return frappe.db.exists("Folio Transaction", {
        "parent": folio_name,
        "posting_date": date,
        "is_void": 0,
        "item": ["in", get_room_rent_item_codes()] 
    })

def get_room_rent_item_codes():
    return frappe.db.sql_list("SELECT name FROM `tabItem` WHERE item_code='ROOM-RENT' OR item_group='Accommodation'")

def handle_overstay(res):
    new_departure = add_days(nowdate(), 1)
    frappe.db.set_value("Hotel Reservation", res.name, "departure_date", new_departure)
    frappe.get_doc("Hotel Reservation", res.name).add_comment("Info", _("Auto-Extended: Guest still in-house at 2 PM."))

def get_rate(rate_plan, room_type, date):
    if not rate_plan:
        return frappe.db.get_value("Hotel Room Type", room_type, "default_rate")
    
    plan = frappe.get_doc("Room Rate Plan", rate_plan)
    if getdate(date) >= getdate(plan.valid_from) and getdate(date) <= getdate(plan.valid_to):
        return plan.rate
    else:
        return frappe.db.get_value("Hotel Room Type", room_type, "default_rate")

def post_room_charge(res, base_amount, date):
    """
    Posts Rent AND Discount transaction if applicable.
    Called by Night Audit AND Check-In process.
    Updates: Checks res.is_company_guest to force 'Company' billing and mirroring.
    """
    folio_name = res.folio
    if not folio_name:
        return
        
    ensure_item_exists("ROOM-RENT", "Room Rent")

    # Determine Bill To
    bill_to = "Guest"
    
    # 1. PRIORITY: Check if flagged as Company Guest
    if res.is_company_guest:
        bill_to = "Company"
    # 2. PRIORITY: Check if flagged as Group Guest
    elif res.get("is_group_guest") and res.get("group_booking"):
        bill_to = "Group"
    else:
        # 3. FALLBACK: Check Routing Instructions
        rent_item_group = frappe.db.get_value("Item", "ROOM-RENT", "item_group")
        routings = frappe.get_all("Reservation Routing", filters={"parent": res.name}, fields=["item_group", "bill_to"])
        for rule in routings:
            if rule.item_group == rent_item_group:
                bill_to = rule.bill_to
                break

    # 1. Post Base Charge
    txn = frappe.get_doc({
        "doctype": "Folio Transaction",
        "parent": folio_name,
        "parenttype": "Guest Folio",
        "parentfield": "transactions",
        "posting_date": date,
        "item": "ROOM-RENT", 
        "description": f"Room Charge - {res.room}",
        "qty": 1,
        "amount": base_amount,
        "bill_to": bill_to
    }).insert(ignore_permissions=True)

    # EXPLICIT MIRRORING
    if bill_to == "Company":
        mirror_to_company_folio(txn)
    elif bill_to == "Group":
        mirror_to_group_folio(txn)

    # 2. Calculate and Post Discount
    discount_amount = 0.0
    discount_desc = ""
    discount_item = "DISCOUNT"

    if res.is_complimentary:
        discount_amount = base_amount
        discount_desc = "Complimentary Adjustment"
        discount_item = "COMPLIMENTARY"
    elif res.discount_type == "Percentage":
        pct = flt(res.discount_value)
        discount_amount = base_amount * (pct / 100.0)
        discount_desc = f"Room Discount ({pct}%)"
    elif res.discount_type == "Amount":
        discount_amount = flt(res.discount_value)
        discount_desc = "Room Discount (Fixed)"

    if discount_amount > 0:
        ensure_item_exists(discount_item, discount_desc)
        
        disc_txn = frappe.get_doc({
            "doctype": "Folio Transaction",
            "parent": folio_name,
            "parenttype": "Guest Folio",
            "parentfield": "transactions",
            "posting_date": date,
            "item": discount_item, 
            "description": discount_desc,
            "qty": 1,
            "amount": -1 * discount_amount, # Negative for credit/reduction
            "bill_to": bill_to
        }).insert(ignore_permissions=True)

        # EXPLICIT MIRRORING: Mirror discount if applicable
        if bill_to == "Company":
            mirror_to_company_folio(disc_txn)
        elif bill_to == "Group":
            mirror_to_group_folio(disc_txn)

    # Sync Balance
    sync_folio_balance(frappe.get_doc("Guest Folio", folio_name))

def ensure_item_exists(code, name):
    if not frappe.db.exists("Item", code):
        item = frappe.new_doc("Item")
        item.item_code = code
        item.item_name = name
        item.item_group = "Services"
        item.is_stock_item = 0
        item.insert(ignore_permissions=True)

------------------------------------------------------------
File: reservation.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import getdate, date_diff, nowdate

def check_availability(room, arrival_date, departure_date, ignore_reservation=None):
    """
    Checks if a room is available for the given date range.
    Returns True if available, raises ValidationError if not.
    """
    if not room or not arrival_date or not departure_date:
        return

    # 1. Check if Room is Enabled (Maintenance check)
    room_status = frappe.db.get_value("Hotel Room", room, ["status", "is_enabled"], as_dict=True)
    if not room_status.is_enabled:
        frappe.throw(_("Room {0} is currently disabled/under maintenance.").format(room))
    
    if room_status.status == "Out of Order":
        frappe.throw(_("Room {0} is marked Out of Order.").format(room))

    # 2. Check Overlapping Reservations
    # Logic: New Arrival < Existing Departure AND New Departure > Existing Arrival
    filters = {
        "room": room,
        "status": ["in", ["Reserved", "Checked In"]],
        "name": ["!=", ignore_reservation] if ignore_reservation else ["is", "set"]
    }
    
    existing_bookings = frappe.get_all("Hotel Reservation", 
        filters=filters,
        fields=["name", "arrival_date", "departure_date", "guest"]
    )

    for booking in existing_bookings:
        # Check for date overlap
        if (getdate(arrival_date) < getdate(booking.departure_date)) and \
           (getdate(departure_date) > getdate(booking.arrival_date)):
             frappe.throw(
                _("Room {0} is already booked by {1} from {2} to {3} (Reservation: {4})").format(
                    room, booking.guest, booking.arrival_date, booking.departure_date, booking.name
                )
             )
    
    return True

@frappe.whitelist()
@frappe.validate_and_sanitize_search_inputs
def get_available_rooms_for_picker(doctype, txt, searchfield, start, page_len, filters):
    """
    Search picker for rooms that are available for the selected dates.
    Filters: arrival_date, departure_date, room_type, ignore_reservation
    """
    arrival = filters.get("arrival_date")
    departure = filters.get("departure_date")
    room_type = filters.get("room_type")
    ignore = filters.get("ignore_reservation")

    if not arrival or not departure:
        # If dates aren't set, return all rooms of that type (or all if no type)
        return frappe.db.sql("""
            SELECT name, room_type, status
            FROM `tabHotel Room`
            WHERE is_enabled = 1
            AND (%s IS NULL OR room_type = %s)
            AND name LIKE %s
            ORDER BY name ASC
            LIMIT %s, %s
        """, (room_type, room_type, f"%{txt}%", start, page_len))

    # Complex Query: Find rooms that are NOT in the overlapping reservations set
    return frappe.db.sql("""
        SELECT name, room_type, status
        FROM `tabHotel Room`
        WHERE is_enabled = 1
        AND status != 'Out of Order'
        AND (%s IS NULL OR room_type = %s)
        AND name LIKE %s
        AND name NOT IN (
            SELECT room FROM `tabHotel Reservation`
            WHERE status IN ('Reserved', 'Checked In')
            AND name != %s
            AND arrival_date < %s
            AND departure_date > %s
        )
        ORDER BY name ASC
        LIMIT %s, %s
    """, (room_type, room_type, f"%{txt}%", ignore or "", departure, arrival, start, page_len))

def create_folio(reservation_doc):
    """
    Creates a 'Provisional' Guest Folio linked to this reservation.
    """
    if frappe.db.exists("Guest Folio", {"reservation": reservation_doc.name, "status": ["!=", "Cancelled"]}):
        return

    folio = frappe.new_doc("Guest Folio")
    folio.guest = reservation_doc.guest
    folio.reservation = reservation_doc.name
    folio.room = reservation_doc.room
    folio.status = "Provisional"
    folio.company = reservation_doc.company # If corporate booking
    folio.open_date = nowdate()
    
    # Save the Folio
    folio.insert(ignore_permissions=True)
    
    # Link Folio back to Reservation
    frappe.db.set_value("Hotel Reservation", reservation_doc.name, "folio", folio.name)
    frappe.msgprint(_("Guest Folio {0} created successfully.").format(folio.name))

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


------------------------------------------------------------
File: pos_bridge.py
------------------------------------------------------------
import frappe
from frappe import _
from frappe.utils import flt
from hospitality_core.hospitality_core.api.folio import mirror_to_company_folio

def process_room_charge(doc, method=None):
    """
    Hook: POS Invoice (on_submit)
    Logic: Breaks down the POS Invoice and posts EACH item to the Guest Folio.
    """
    
    # 1. Calculate how much of this invoice is being charged to the room
    room_charge_payment = 0
    for pay in doc.payments:
        if pay.mode_of_payment == "Room Charge":
            room_charge_payment += flt(pay.amount)
            
    if room_charge_payment <= 0:
        return

    # 2. Get the Room and Active Folio
    if not hasattr(doc, 'hotel_room') or not doc.hotel_room:
        frappe.throw(_("Please select a Hotel Room for the Room Charge."))

    folio_name = frappe.db.get_value("Guest Folio", 
        {"room": doc.hotel_room, "status": "Open"}, "name"
    )
    
    if not folio_name:
        frappe.throw(_("No open Folio found for Room {0}.").format(doc.hotel_room))

    # 3. Determine the ratio (in case of split payments like half cash / half room charge)
    # This ensures the sales price on the folio matches the portion charged to the room
    invoice_total = flt(doc.grand_total)
    ratio = room_charge_payment / invoice_total if invoice_total > 0 else 1

    # 4. Determine Bill To logic (Company vs Guest)
    bill_to = "Guest"
    res_name = frappe.db.get_value("Guest Folio", folio_name, "reservation")
    if res_name:
        is_corp = frappe.db.get_value("Hotel Reservation", res_name, "is_company_guest")
        if is_corp:
            bill_to = "Company"

    # 5. POST EACH ITEM INDIVIDUALLY
    for item in doc.items:
        # Calculate the actual price for this item based on the room charge portion
        posted_amount = flt(item.amount) * ratio
        
        txn = frappe.get_doc({
            "doctype": "Folio Transaction",
            "parent": folio_name,
            "parenttype": "Guest Folio",
            "parentfield": "transactions",
            "posting_date": doc.posting_date,
            "item": item.item_code, # Uses the actual item bought (e.g., 'HEINEKEN')
            "description": f"{item.item_name} (POS: {doc.name})",
            "qty": item.qty,
            "amount": posted_amount, # This is the sales price from the POS
            "bill_to": bill_to,
            "reference_doctype": "POS Invoice",
            "reference_name": doc.name,
            "is_invoiced": 1
        })
        txn.insert(ignore_permissions=True)

        # Mirror to Company Folio if the guest is a corporate guest
        if bill_to == "Company":
            mirror_to_company_folio(txn)

    # 6. Refresh the Folio Balance
    from hospitality_core.hospitality_core.api.folio import sync_folio_balance
    sync_folio_balance(frappe.get_doc("Guest Folio", folio_name))

    frappe.msgprint(_("Posted {0} items from POS to Folio {1}").format(len(doc.items), folio_name))

------------------------------------------------------------
File: group_booking.py
------------------------------------------------------------
import frappe
from frappe import _

@frappe.whitelist()
def create_master_folio(group_booking_name):
    doc = frappe.get_doc("Hotel Group Booking", group_booking_name)
    
    if doc.master_folio:
        frappe.throw(_("Master Folio already exists: {0}").format(doc.master_folio))

    if not doc.master_payer:
        frappe.throw(_("Please select a Master Payer (Customer) before creating a Folio."))

    # Create a "Dummy" Guest record for the Group if needed, or link to a generic placeholder.
    # Ideally, we create a Guest record representing the Event Organizer.
    # For this implementation, we assume a Guest record exists or we create one on the fly.
    
    organizer_guest = frappe.db.get_value("Guest", {"customer": doc.master_payer}, "name")
    if not organizer_guest:
        # Create a proxy guest for the company
        g = frappe.new_doc("Guest")
        g.full_name = doc.group_name
        g.customer = doc.master_payer
        g.insert(ignore_permissions=True)
        organizer_guest = g.name

    # Create the Master Folio
    folio = frappe.new_doc("Guest Folio")
    folio.guest = organizer_guest
    folio.company = doc.master_payer
    # We don't link a specific room or reservation, but we flag it as a Group Master
    folio.status = "Open"
    folio.save(ignore_permissions=True)
    
    # Link back
    doc.db_set("master_folio", folio.name)
    
    return folio.name

@frappe.whitelist()
def add_rooms_to_group(group_booking, rooms):
    """
    rooms: JSON string list of room names or reservations
    Logic to mass-update reservations to link them to this group.
    """
    import json
    room_list = json.loads(rooms)
    
    # room_list might be strings (IDs) or objects depending on client input
    for res_data in room_list:
        res_name = res_data if isinstance(res_data, str) else res_data.get('name') or res_data.get('hotel_reservation')
        if res_name:
            frappe.db.set_value("Hotel Reservation", res_name, {
                "group_booking": group_booking,
                "is_group_guest": 1 # Auto-flag as group guest
            })
        
    return True

@frappe.whitelist()
def mass_check_in(group_booking):
    """
    Finds all 'Reserved' bookings linked to this group and checks them in.
    """
    reservations = frappe.get_all("Hotel Reservation", 
        filters={"group_booking": group_booking, "status": "Reserved"},
        fields=["name"]
    )
    
    if not reservations:
        return {"message": _("No reserved bookings found for this group.")}
        
    count = 0
    for r in reservations:
        try:
            doc = frappe.get_doc("Hotel Reservation", r.name)
            doc.process_check_in()
            count += 1
        except Exception as e:
            frappe.log_error(message=str(e), title=f"Group Checkin Error: {r.name}")
            
    return {"message": _("Successfully Checked In {0} guests.").format(count)}

@frappe.whitelist()
def mass_check_out(group_booking):
    """
    Finds all 'Checked In' bookings linked to this group and checks them out.
    """
    reservations = frappe.get_all("Hotel Reservation", 
        filters={"group_booking": group_booking, "status": "Checked In"},
        fields=["name"]
    )
    
    if not reservations:
        return {"message": _("No in-house guests found for this group to check out.")}
        
    count = 0
    for r in reservations:
        try:
            doc = frappe.get_doc("Hotel Reservation", r.name)
            doc.process_check_out()
            count += 1
        except Exception as e:
            frappe.log_error(message=str(e), title=f"Group Checkout Error: {r.name}")
            
    return {"message": _("Successfully Checked Out {0} guests.").format(count)}

================================================================================
Folder: hospitality_core/api/__pycache__
================================================================================

------------------------------------------------------------
File: night_audit.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: room_move.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: reservation.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: payment_bridge.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: financial_control.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: pos_bridge.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: invoicing.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: folio.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


------------------------------------------------------------
File: group_booking.cpython-312.pyc
------------------------------------------------------------
Could not read file: 'utf-8' codec can't decode byte 0xcb in position 0: invalid continuation byte

================================================================================
Folder: apps
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: apps/hospitality_core
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: apps/hospitality_core/hospitality_core
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: apps/hospitality_core/hospitality_core/hospitality_core
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: apps/hospitality_core/hospitality_core/hospitality_core/print_format
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: apps/hospitality_core/hospitality_core/hospitality_core/print_format/guest_folio_classic
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: www
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: public
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: public/css
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------


================================================================================
Folder: public/js
================================================================================

------------------------------------------------------------
File: __init__.py
------------------------------------------------------------

